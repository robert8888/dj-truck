{"ast":null,"code":"import _objectSpread from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _classCallCheck from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import{useMemo,useState,useEffect,useCallback}from\"react\";import{getApi}from\"./../../../apis/apiProvider\";import{PLAYBACK_STATE}from\"./usePlabackState\";//getRecordUrl\nvar Player=/*#__PURE__*/function(){function Player(){_classCallCheck(this,Player);this.progressUpdaterHandler=null;this.current={id:null,start:0,duration:0,progress:0,state:null,buffered:0};this.btnStateHandlers={};this.progressSubscribers={};this.bufferedSubscribers=[];this.progressProviders={};this.currentSubscribers=[];if(!Player.instance){Player.instance=this;}return Player.instance;}_createClass(Player,[{key:\"setCurrent\",value:function setCurrent(nextCurrent){this.current=nextCurrent;this.spreadCurrentChange();}},{key:\"subscribeCurrent\",value:function subscribeCurrent(handler){this.currentSubscribers.push(handler);handler(this.current);}},{key:\"unSubscribeCurrent\",value:function unSubscribeCurrent(handler){this.currentSubscribers=this.currentSubscribers.filter(function(fun){return!fun===handler;});}},{key:\"spreadCurrentChange\",value:function spreadCurrentChange(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.currentSubscribers[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var handler=_step.value;handler(this.current);}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return!=null){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}},{key:\"getCurrent\",value:function getCurrent(){return this.current;}},{key:\"addBtnCtrlHandler\",value:function addBtnCtrlHandler(id,handler){this.btnStateHandlers[id]=handler;}},{key:\"removeBtnCtrlHandler\",value:function removeBtnCtrlHandler(id){delete this.btnStateHandlers[id];}},{key:\"setBtnState\",value:function setBtnState(id,state){if(this.btnStateHandlers[id]){this.btnStateHandlers[id](state);}}},{key:\"subscribeProgress\",value:function subscribeProgress(id,handler){if(this.progressSubscribers[id]){this.progressSubscribers[id].push(handler);}else{this.progressSubscribers[id]=[handler];}}},{key:\"unSubscribeProgress\",value:function unSubscribeProgress(id,handler){this.progressSubscribers[id]=this.progressSubscribers[id].filter(function(fun){return fun!==handler;});}},{key:\"setProgress\",value:function setProgress(progress){this.current.progress=progress;this.spreadProgressChanges();}},{key:\"spreadProgressChanges\",value:function spreadProgressChanges(){var _this$current=this.current,id=_this$current.id,progress=_this$current.progress;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.progressSubscribers[id][Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var handler=_step2.value;handler(progress);}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return!=null){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=(this.progressSubscribers['#']||[])[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var _handler=_step3.value;_handler(progress);}}catch(err){_didIteratorError3=true;_iteratorError3=err;}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return!=null){_iterator3.return();}}finally{if(_didIteratorError3){throw _iteratorError3;}}}}},{key:\"addProgressProvider\",value:function addProgressProvider(id,handler){this.progressProviders[id]=handler;}},{key:\"removeProgressProvider\",value:function removeProgressProvider(id){delete this.progressProviders[id];}},{key:\"getProgress\",value:function getProgress(id){if(!id){return this.getProgress(this.current.id);}return this.progressProviders[id]();}},{key:\"setBuffered\",value:function setBuffered(buffered){if(this.current.id){this.current.buffered=buffered;}this.spreadBufferChanges();}},{key:\"subscribeBuffred\",value:function subscribeBuffred(handel){this.bufferedSubscribers.push(handel);}},{key:\"unSubscribeBuffered\",value:function unSubscribeBuffered(handler){this.bufferedSubscribers=this.bufferedSubscribers.filter(function(fun){return fun!==handler;});}},{key:\"spreadBufferChanges\",value:function spreadBufferChanges(){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this.bufferedSubscribers[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var handler=_step4.value;handler(this.current.buffered);}}catch(err){_didIteratorError4=true;_iteratorError4=err;}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return!=null){_iterator4.return();}}finally{if(_didIteratorError4){throw _iteratorError4;}}}}}]);return Player;}();export function useRecordPlayer(){var _useState=useState(new Player()),_useState2=_slicedToArray(_useState,1),player=_useState2[0];var api=useMemo(function(){return getApi('RecordsStore');},[]);useEffect(function(){player.mediaElement=player.mediaElement||document.createElement('audio');// player.mediaElement.type = \"audio/mp3\";\n},[player]);var startUpdateProg=useCallback(function(){var handler=setInterval(function(){var mediaEl=player.mediaElement;var progress=mediaEl.currentTime/(player.current.duration/1000);player.setProgress(progress);//--\nvar bufferdTimeRanges=mediaEl.buffered;if(bufferdTimeRanges.length){var end=bufferdTimeRanges.end(bufferdTimeRanges.length-1);player.setBuffered(end/(player.current.duration/1000));}},400);player.progressUpdaterHandler=handler;},[player]);var stopUpdateProg=useCallback(function(){clearInterval(player.progressUpdaterHandler);},[player]);useEffect(function(){var media=player.mediaElement;if(media){media.addEventListener(\"ended\",function(){if(player.current.state===PLAYBACK_STATE.PLAY){player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PAUSE}));player.setBtnState(player.current.id,PLAYBACK_STATE.PAUSE);}stopUpdateProg();console.log(\"media element ended event\");});media.addEventListener('progress',function(){var bufferdTimeRanges=media.buffered;if(bufferdTimeRanges.length){var end=bufferdTimeRanges.end(bufferdTimeRanges.length-1);player.setBuffered(end/(player.current.duration/1000));}});}},[player,stopUpdateProg]);var playback=useCallback(function(id,pbState){var media=player.mediaElement;var current=id?false:true;id=id||player.current.id;if(!id){return;}if(pbState===PLAYBACK_STATE.PLAY){var progress,duration;if(current){var _player$getProgress=player.getProgress(\"#\");progress=_player$getProgress.progress;duration=_player$getProgress.duration;}else{var _player$getProgress2=player.getProgress(id);progress=_player$getProgress2.progress;duration=_player$getProgress2.duration;}var position=duration/1000*progress;media.src=api.getRecordUrl(id);media.currentTime=position;media.play().catch(function(err){return console.log('Play action was aborded'+err);});if(player.current.id&&!current){player.setBtnState(player.current.id,PLAYBACK_STATE.PAUSE);}player.setCurrent({id:id,duration:duration,progress:progress,buffered:0,state:PLAYBACK_STATE.PLAY});startUpdateProg();}else if(pbState===PLAYBACK_STATE.PAUSE){if(media.readyState>=2){media.pause();}else{media.load();}player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PAUSE}));stopUpdateProg();}if(current){player.setBtnState(id,pbState);}},[api,player,stopUpdateProg,startUpdateProg]);var seek=useCallback(function(_ref){var _ref$id=_ref.id,id=_ref$id===void 0?player.current.id:_ref$id,progress=_ref.progress,_ref$duration=_ref.duration,duration=_ref$duration===void 0?player.current.duration:_ref$duration;var mediaEl=player.mediaElement;if(!id||!duration){return;}if(player.current.id&&player.current.id!==id){player.setBtnState(player.current.id,PLAYBACK_STATE.PAUSE);}var position=duration/1000*progress;if(isNaN(position)){return;}stopUpdateProg();if(player.current.id!==id){mediaEl.src=api.getRecordUrl(id);mediaEl.currentTime=position;player.setBtnState(id,PLAYBACK_STATE.PLAY);player.setCurrent(_objectSpread({},player.current,{id:id,duration:duration,state:PLAYBACK_STATE.PLAY}));player.setProgress(progress);}mediaEl.currentTime=position;if(mediaEl.pause){mediaEl.play().catch(function(err){return console.log('Play action was aborded'+err);});player.setBtnState(player.current.id,PLAYBACK_STATE.PLAY);player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PLAY}));}startUpdateProg();},[player,api,stopUpdateProg,startUpdateProg]);var setVolume=useCallback(function(level){var mediaElement=player.mediaElement;if(!mediaElement){return;}mediaElement.volume=level;},[player]);var stop=useCallback(function(){var mediaElement=player.mediaElement;mediaElement.load();},[player]);var controls={playback:playback,seek:seek,setVolume:setVolume,stop:stop};return[controls,player];}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/Hooks/useRecordPlayer.js"],"names":["useMemo","useState","useEffect","useCallback","getApi","PLAYBACK_STATE","Player","progressUpdaterHandler","current","id","start","duration","progress","state","buffered","btnStateHandlers","progressSubscribers","bufferedSubscribers","progressProviders","currentSubscribers","instance","nextCurrent","spreadCurrentChange","handler","push","filter","fun","spreadProgressChanges","getProgress","spreadBufferChanges","handel","useRecordPlayer","player","api","mediaElement","document","createElement","startUpdateProg","setInterval","mediaEl","currentTime","setProgress","bufferdTimeRanges","length","end","setBuffered","stopUpdateProg","clearInterval","media","addEventListener","PLAY","setCurrent","PAUSE","setBtnState","console","log","playback","pbState","position","src","getRecordUrl","play","catch","err","readyState","pause","load","seek","isNaN","setVolume","level","volume","stop","controls"],"mappings":"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","sourcesContent":["import { useMemo, useState, useEffect, useCallback } from \"react\"\r\nimport { getApi } from \"./../../../apis/apiProvider\";\r\nimport { PLAYBACK_STATE } from \"./usePlabackState\";\r\n\r\n//getRecordUrl\r\nclass Player {\r\n    constructor(){\r\n        if(!Player.instance){\r\n            Player.instance = this;\r\n        } \r\n            \r\n        return Player.instance;\r\n    }\r\n    \r\n\r\n    progressUpdaterHandler = null;\r\n\r\n    current = {\r\n        id: null,\r\n        start: 0,\r\n        duration: 0,\r\n        progress: 0,\r\n        state: null,\r\n        buffered: 0,\r\n    };\r\n\r\n    btnStateHandlers = {}\r\n    progressSubscribers = {}\r\n    bufferedSubscribers = []\r\n    progressProviders = {};\r\n    currentSubscribers = [];\r\n\r\n    setCurrent(nextCurrent) {\r\n        this.current = nextCurrent;\r\n        this.spreadCurrentChange();\r\n    }\r\n\r\n    subscribeCurrent(handler) {\r\n        this.currentSubscribers.push(handler)\r\n        handler(this.current)\r\n    }\r\n\r\n    unSubscribeCurrent(handler) {\r\n        this.currentSubscribers = this.currentSubscribers.filter(fun => !fun === handler);\r\n    }\r\n\r\n    spreadCurrentChange() {\r\n        for (let handler of this.currentSubscribers) {\r\n           handler(this.current);\r\n        }\r\n    }\r\n\r\n    getCurrent(){\r\n        return this.current;\r\n    }\r\n\r\n    addBtnCtrlHandler(id, handler) {\r\n        this.btnStateHandlers[id] = handler;\r\n    }\r\n\r\n    removeBtnCtrlHandler(id){\r\n        delete this.btnStateHandlers[id]\r\n    }\r\n\r\n    setBtnState(id, state) {\r\n        if(this.btnStateHandlers[id]){\r\n            this.btnStateHandlers[id](state)\r\n        }\r\n    }\r\n\r\n\r\n    subscribeProgress(id, handler) {\r\n        if (this.progressSubscribers[id]) {\r\n            this.progressSubscribers[id].push(handler);\r\n\r\n        } else {\r\n            this.progressSubscribers[id] = [handler];\r\n        }\r\n    }\r\n\r\n    unSubscribeProgress(id, handler) {\r\n        this.progressSubscribers[id] = this.progressSubscribers[id].filter(fun => fun !== handler);\r\n    }\r\n\r\n    setProgress(progress) {\r\n        this.current.progress = progress;\r\n        this.spreadProgressChanges();\r\n    }\r\n\r\n    spreadProgressChanges(){\r\n        const {id, progress} = this.current;\r\n        for (let handler of this.progressSubscribers[id]) {\r\n            handler(progress);\r\n        }\r\n        for (let handler of this.progressSubscribers['#'] || []) {\r\n            handler(progress);\r\n        }\r\n    }\r\n\r\n    addProgressProvider(id, handler) {\r\n        this.progressProviders[id] = handler;\r\n    }\r\n\r\n    removeProgressProvider(id) {\r\n        delete this.progressProviders[id];\r\n    }\r\n\r\n    getProgress(id) {\r\n        if (!id) {\r\n            return this.getProgress(this.current.id);\r\n        }\r\n        return this.progressProviders[id]();\r\n    }\r\n\r\n    setBuffered(buffered) {\r\n        if (this.current.id) {\r\n            this.current.buffered = buffered;\r\n        }\r\n        this.spreadBufferChanges();\r\n    }\r\n\r\n    subscribeBuffred(handel) {\r\n        this.bufferedSubscribers.push(handel)\r\n    }\r\n\r\n    unSubscribeBuffered(handler) {\r\n        this.bufferedSubscribers = this.bufferedSubscribers.filter(fun =>\r\n            fun !== handler\r\n        );\r\n    }\r\n\r\n    spreadBufferChanges() {\r\n        for (let handler of this.bufferedSubscribers) {\r\n            handler(this.current.buffered);\r\n        }\r\n    }\r\n}\r\n\r\nexport function useRecordPlayer() {\r\n    const [player,] = useState(new Player())\r\n\r\n    const api = useMemo(() => {\r\n        return getApi('RecordsStore');\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        player.mediaElement = player.mediaElement || document.createElement('audio');\r\n       // player.mediaElement.type = \"audio/mp3\";\r\n    }, [player])\r\n\r\n    const startUpdateProg = useCallback(() => {\r\n        const handler = setInterval(() => {\r\n            const mediaEl = player.mediaElement;\r\n            const progress = mediaEl.currentTime / (player.current.duration / 1000);\r\n            player.setProgress(progress);\r\n            //--\r\n            const bufferdTimeRanges = mediaEl.buffered;\r\n            if (bufferdTimeRanges.length) {\r\n                const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                player.setBuffered(end / (player.current.duration / 1000))\r\n            }\r\n        }, 400)\r\n        player.progressUpdaterHandler = handler;\r\n        \r\n    }, [player])\r\n\r\n    const stopUpdateProg = useCallback(() => {\r\n        clearInterval(player.progressUpdaterHandler);\r\n    }, [player])\r\n\r\n    useEffect(() => {\r\n        const media = player.mediaElement;\r\n        if (media) {\r\n            media.addEventListener(\"ended\", () => {\r\n                if (player.current.state === PLAYBACK_STATE.PLAY) {\r\n                    player.setCurrent({\r\n                        ...player.current,\r\n                        state: PLAYBACK_STATE.PAUSE,\r\n                    })\r\n                    player.setBtnState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n                }\r\n                stopUpdateProg();\r\n                console.log(\"media element ended event\")\r\n            })\r\n            media.addEventListener('progress', () => {\r\n                const bufferdTimeRanges = media.buffered;\r\n                if (bufferdTimeRanges.length) {\r\n                    const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                    player.setBuffered(end / (player.current.duration / 1000))\r\n                }\r\n            })\r\n        }\r\n    }, [player, stopUpdateProg])\r\n\r\n    const playback = useCallback((id, pbState) => {\r\n        const media = player.mediaElement;\r\n        const current = (id) ? false : true;\r\n        id = id || player.current.id;\r\n        if (!id) {\r\n            return;\r\n        }\r\n\r\n        if (pbState === PLAYBACK_STATE.PLAY) {\r\n            let  progress, duration; \r\n            if(current) {\r\n                ({progress, duration } = player.getProgress(\"#\"));\r\n            } else {\r\n                ({progress, duration } = player.getProgress(id));\r\n            }\r\n            const position = (duration / 1000) * progress;\r\n            media.src = api.getRecordUrl(id);\r\n            media.currentTime = position;\r\n            media.play().catch(err => console.log('Play action was aborded' + err));\r\n            if (player.current.id && !current) {\r\n                player.setBtnState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n            }\r\n            player.setCurrent({\r\n                id,\r\n                duration,\r\n                progress: progress,\r\n                buffered: 0,\r\n                state: PLAYBACK_STATE.PLAY,\r\n            })\r\n            startUpdateProg()\r\n        } else if (pbState === PLAYBACK_STATE.PAUSE) {\r\n            if (media.readyState >= 2) {\r\n                media.pause();\r\n            } else {\r\n                media.load();\r\n            }\r\n\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PAUSE\r\n            })\r\n            stopUpdateProg();\r\n        }\r\n        if (current) {\r\n            player.setBtnState(id, pbState)\r\n        }\r\n    }, [api,\r\n        player,\r\n        stopUpdateProg,\r\n        startUpdateProg,\r\n    ])\r\n\r\n    const seek = useCallback(({\r\n        id = player.current.id,\r\n        progress,\r\n        duration = player.current.duration\r\n    }) => {\r\n\r\n        const mediaEl = player.mediaElement;\r\n\r\n        if (!id || !duration) {\r\n            return;\r\n        }\r\n\r\n\r\n\r\n        if (player.current.id && player.current.id !== id) {\r\n            player.setBtnState(player.current.id, PLAYBACK_STATE.PAUSE);\r\n        }\r\n        const position = (duration / 1000) * progress;\r\n\r\n        if (isNaN(position)) {\r\n            return;\r\n        }\r\n\r\n        stopUpdateProg();\r\n\r\n        if (player.current.id !== id) {\r\n            mediaEl.src = api.getRecordUrl(id);\r\n            mediaEl.currentTime = position;\r\n            player.setBtnState(id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                id,\r\n                duration,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n            player.setProgress(progress);\r\n        }\r\n\r\n        mediaEl.currentTime = position;\r\n        if (mediaEl.pause) {\r\n            mediaEl.play().catch(err => console.log('Play action was aborded' + err));\r\n            player.setBtnState(player.current.id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n        }\r\n        startUpdateProg();\r\n    }, [player, api, stopUpdateProg, startUpdateProg])\r\n\r\n    const setVolume = useCallback((level) => {\r\n        const mediaElement =  player.mediaElement;\r\n        if (!mediaElement) {\r\n            return;\r\n        }\r\n        mediaElement.volume = level;\r\n    }, [player])\r\n\r\n    const stop = useCallback(() => {\r\n        const mediaElement =  player.mediaElement;\r\n        mediaElement.load();\r\n    }, [player])\r\n\r\n    const controls = {\r\n        playback,\r\n        seek,\r\n        setVolume,\r\n        stop,\r\n    }\r\n\r\n    return [\r\n        controls,\r\n        player\r\n    ]\r\n}"]},"metadata":{},"sourceType":"module"}
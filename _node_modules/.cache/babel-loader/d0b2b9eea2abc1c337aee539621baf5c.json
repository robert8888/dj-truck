{"ast":null,"code":"import { useCallback, useEffect, useState } from \"react\";\nimport { Log, Logger } from \"../../../utils/logger/logger\";\nimport { getApi } from \"./../../../apis/apiProvider\";\nimport { PLAYBACK_STATE } from \"./usePlabackState\"; //getRecordUrl\n\nclass PlayerBus {\n  constructor() {\n    this.progressUpdaterHandler = null;\n    this.current = {\n      id: null,\n      source: \"RecordsStore\",\n      start: 0,\n      duration: 0,\n      progress: 0,\n      state: null,\n      buffered: 0\n    };\n    this.playbackSubscirbers = {};\n    this.progressSubscribers = {};\n    this.bufferedSubscribers = [];\n    this.progressProviders = {};\n    this.currentSubscribers = [];\n\n    if (!PlayerBus.instance) {\n      PlayerBus.instance = this;\n    }\n\n    return PlayerBus.instance;\n  }\n\n  setCurrent(nextCurrent) {\n    this.current = nextCurrent;\n    this.spreadCurrentChange();\n  }\n\n  subscribeCurrent(handler) {\n    this.currentSubscribers.push(handler);\n    handler(this.current);\n  }\n\n  unSubscribeCurrent(handler) {\n    this.currentSubscribers = this.currentSubscribers.filter(fun => !fun === handler);\n  }\n\n  spreadCurrentChange() {\n    for (let handler of this.currentSubscribers) {\n      handler(this.current);\n    }\n  }\n\n  getCurrent() {\n    return this.current;\n  }\n\n  subscribePlayback(id, handler) {\n    this.playbackSubscirbers[id] = handler;\n  }\n\n  unSubscribePlayback(id) {\n    delete this.playbackSubscirbers[id];\n  }\n\n  setPlaybackState(id, state) {\n    if (this.playbackSubscirbers[id]) {\n      this.playbackSubscirbers[id](state);\n    }\n  }\n\n  subscribeProgress(id, handler) {\n    if (this.progressSubscribers[id]) {\n      this.progressSubscribers[id].push(handler);\n    } else {\n      this.progressSubscribers[id] = [handler];\n    }\n  }\n\n  unSubscribeProgress(id, handler) {\n    this.progressSubscribers[id] = this.progressSubscribers[id].filter(fun => fun !== handler);\n  }\n\n  setProgress(progress) {\n    this.current.progress = progress;\n    this.spreadProgressChanges();\n  }\n\n  spreadProgressChanges() {\n    const {\n      id,\n      progress\n    } = this.current;\n\n    for (let handler of this.progressSubscribers['#'] || []) {\n      handler(progress);\n    }\n\n    if (!this.progressSubscribers[id]) return;\n\n    for (let handler of this.progressSubscribers[id]) {\n      handler(progress);\n    }\n  }\n\n  addProgressProvider(id, handler) {\n    this.progressProviders[id] = handler;\n  }\n\n  removeProgressProvider(id) {\n    delete this.progressProviders[id];\n  }\n\n  getProgress(id) {\n    if (!id) {\n      return this.getProgress(this.current.id);\n    }\n\n    if (!id || !this.progressProviders[id]) {\n      return this.current.progress;\n    }\n\n    return this.progressProviders[id]();\n  }\n\n  setBuffered(buffered) {\n    if (this.current.id) {\n      this.current.buffered = buffered;\n    }\n\n    this.spreadBufferChanges();\n  }\n\n  subscribeBuffred(handel) {\n    this.bufferedSubscribers.push(handel);\n  }\n\n  unSubscribeBuffered(handler) {\n    this.bufferedSubscribers = this.bufferedSubscribers.filter(fun => fun !== handler);\n  }\n\n  spreadBufferChanges() {\n    for (let handler of this.bufferedSubscribers) {\n      handler(this.current.buffered);\n    }\n  }\n\n}\n\nexport function usePlayer() {\n  const [player] = useState(new PlayerBus());\n  useEffect(() => {\n    player.mediaElement = player.mediaElement || document.createElement('audio'); // player.mediaElement.type = \"audio/mp3\";\n  }, [player]);\n  const startUpdateProg = useCallback(() => {\n    const handler = setInterval(() => window.requestIdleCallback(() => {\n      if (player.current.state === PLAYBACK_STATE.PAUSE) {\n        clearInterval(handler);\n      }\n\n      console.log(player.current);\n      const mediaEl = player.mediaElement;\n\n      if (!player.current.duration) {\n        player.current.duration = mediaEl.duration * 1000;\n      }\n\n      const progress = mediaEl.currentTime / (player.current.duration / 1000);\n      player.setProgress(progress); //--\n\n      const bufferdTimeRanges = mediaEl.buffered;\n\n      if (bufferdTimeRanges.length) {\n        const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\n        player.setBuffered(end / (player.current.duration / 1000));\n      }\n    }, {\n      timeout: 20\n    }), 400);\n    player.progressUpdaterHandler = handler;\n  }, [player]);\n  const stopUpdateProg = useCallback(() => {\n    clearInterval(player.progressUpdaterHandler);\n  }, [player]);\n  useEffect(() => {\n    const media = player.mediaElement;\n\n    if (media) {\n      media.addEventListener(\"ended\", () => {\n        if (player.current.state === PLAYBACK_STATE.PLAY) {\n          player.setCurrent({ ...player.current,\n            state: PLAYBACK_STATE.PAUSE\n          });\n          player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE);\n        }\n\n        stopUpdateProg();\n      });\n      media.addEventListener('progress', () => {\n        const bufferdTimeRanges = media.buffered;\n\n        if (bufferdTimeRanges.length) {\n          const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\n          player.setBuffered(end / (player.current.duration / 1000));\n        }\n      });\n    }\n  }, [player, stopUpdateProg]);\n  const playback = useCallback((id, pbState, source) => {\n    id = id || player.current.id;\n    source = source || player.current.source || \"RecordsStore\";\n    const api = getApi(source);\n    const media = player.mediaElement;\n    const isCurrent = id === player.current.id;\n\n    if (!id) {\n      return;\n    }\n\n    console.log(\"playback\", id, pbState, source);\n\n    if (pbState === PLAYBACK_STATE.PLAY) {\n      let progress, duration;\n\n      if (isCurrent) {\n        ({\n          progress,\n          duration\n        } = player.getProgress(\"#\"));\n      } else {\n        ({\n          progress,\n          duration\n        } = player.getProgress(id));\n      }\n\n      const position = duration / 1000 * progress;\n      media.src = api.getStreamUrl(id);\n\n      if (!isNaN(position)) {\n        media.currentTime = position;\n      }\n\n      media.play().catch(error => {\n        Logger.push(Log.Error(['usePlayer', 'playback method'], 'Media element play method error' + error.message, error));\n      });\n\n      if (player.current.id && !isCurrent) {\n        player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE);\n      }\n\n      player.setCurrent({\n        id,\n        source,\n        duration,\n        progress,\n        buffered: 0,\n        state: PLAYBACK_STATE.PLAY\n      });\n      startUpdateProg();\n    } else if (pbState === PLAYBACK_STATE.PAUSE) {\n      if (media.readyState >= 2) {\n        media.pause();\n      } else {\n        media.load();\n      }\n\n      player.setCurrent({ ...player.current,\n        state: PLAYBACK_STATE.PAUSE\n      });\n      stopUpdateProg();\n    }\n\n    if (isCurrent) {\n      player.setPlaybackState(id, pbState);\n    }\n  }, [player, stopUpdateProg, startUpdateProg]);\n  const seek = useCallback(({\n    id = player.current.id,\n    progress,\n    duration = player.current.duration,\n    source = 'RecordsStore'\n  }) => {\n    const mediaEl = player.mediaElement;\n    const api = getApi(source);\n\n    if (!id || !duration) {\n      return;\n    }\n\n    if (player.current.id && player.current.id !== id) {\n      player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE);\n    }\n\n    const position = duration / 1000 * progress;\n\n    if (isNaN(position)) {\n      return;\n    }\n\n    stopUpdateProg();\n\n    if (player.current.id !== id) {\n      mediaEl.src = api.getStreamUrl(id);\n      mediaEl.currentTime = position;\n      player.setPlaybackState(id, PLAYBACK_STATE.PLAY);\n      player.setCurrent({ ...player.current,\n        id,\n        source,\n        duration,\n        state: PLAYBACK_STATE.PLAY\n      });\n      player.setProgress(progress);\n    }\n\n    mediaEl.currentTime = position;\n\n    if (mediaEl.pause) {\n      mediaEl.play().catch(err => console.log('Play action was aborded' + err));\n      player.setPlaybackState(player.current.id, PLAYBACK_STATE.PLAY);\n      player.setCurrent({ ...player.current,\n        state: PLAYBACK_STATE.PLAY\n      });\n    }\n\n    startUpdateProg();\n  }, [player, stopUpdateProg, startUpdateProg]);\n  const setVolume = useCallback(level => {\n    const mediaElement = player.mediaElement;\n\n    if (!mediaElement) {\n      return;\n    }\n\n    mediaElement.volume = level;\n  }, [player]);\n  const stop = useCallback(() => {\n    const mediaElement = player.mediaElement;\n    mediaElement.load();\n  }, [player]);\n  const controls = {\n    playback,\n    seek,\n    setVolume,\n    stop\n  };\n  return [controls, player];\n}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/Hooks/usePlayer.js"],"names":["useCallback","useEffect","useState","Log","Logger","getApi","PLAYBACK_STATE","PlayerBus","constructor","progressUpdaterHandler","current","id","source","start","duration","progress","state","buffered","playbackSubscirbers","progressSubscribers","bufferedSubscribers","progressProviders","currentSubscribers","instance","setCurrent","nextCurrent","spreadCurrentChange","subscribeCurrent","handler","push","unSubscribeCurrent","filter","fun","getCurrent","subscribePlayback","unSubscribePlayback","setPlaybackState","subscribeProgress","unSubscribeProgress","setProgress","spreadProgressChanges","addProgressProvider","removeProgressProvider","getProgress","setBuffered","spreadBufferChanges","subscribeBuffred","handel","unSubscribeBuffered","usePlayer","player","mediaElement","document","createElement","startUpdateProg","setInterval","window","requestIdleCallback","PAUSE","clearInterval","console","log","mediaEl","currentTime","bufferdTimeRanges","length","end","timeout","stopUpdateProg","media","addEventListener","PLAY","playback","pbState","api","isCurrent","position","src","getStreamUrl","isNaN","play","catch","error","Error","message","readyState","pause","load","seek","err","setVolume","level","volume","stop","controls"],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\r\nimport { Log, Logger } from \"../../../utils/logger/logger\";\r\nimport { getApi } from \"./../../../apis/apiProvider\";\r\nimport { PLAYBACK_STATE } from \"./usePlabackState\";\r\n\r\n//getRecordUrl\r\nclass PlayerBus {\r\n    constructor() {\r\n        if (!PlayerBus.instance) {\r\n            PlayerBus.instance = this;\r\n        }\r\n\r\n        return PlayerBus.instance;\r\n    }\r\n\r\n\r\n    progressUpdaterHandler = null;\r\n\r\n    current = {\r\n        id: null,\r\n        source: \"RecordsStore\",\r\n        start: 0,\r\n        duration: 0,\r\n        progress: 0,\r\n        state: null,\r\n        buffered: 0,\r\n    };\r\n\r\n    playbackSubscirbers = {}\r\n    progressSubscribers = {}\r\n    bufferedSubscribers = []\r\n    progressProviders = {};\r\n    currentSubscribers = [];\r\n\r\n    setCurrent(nextCurrent) {\r\n        this.current = nextCurrent;\r\n        this.spreadCurrentChange();\r\n    }\r\n\r\n    subscribeCurrent(handler) {\r\n        this.currentSubscribers.push(handler)\r\n        handler(this.current)\r\n    }\r\n\r\n    unSubscribeCurrent(handler) {\r\n        this.currentSubscribers = this.currentSubscribers.filter(fun => !fun === handler);\r\n    }\r\n\r\n    spreadCurrentChange() {\r\n        for (let handler of this.currentSubscribers) {\r\n            handler(this.current);\r\n        }\r\n    }\r\n\r\n    getCurrent() {\r\n        return this.current;\r\n    }\r\n\r\n    subscribePlayback(id, handler) {\r\n        this.playbackSubscirbers[id] = handler;\r\n    }\r\n\r\n    unSubscribePlayback(id) {\r\n        delete this.playbackSubscirbers[id]\r\n    }\r\n\r\n    setPlaybackState(id, state) {\r\n        if (this.playbackSubscirbers[id]) {\r\n            this.playbackSubscirbers[id](state)\r\n        }\r\n    }\r\n\r\n\r\n    subscribeProgress(id, handler) {\r\n        if (this.progressSubscribers[id]) {\r\n            this.progressSubscribers[id].push(handler);\r\n\r\n        } else {\r\n            this.progressSubscribers[id] = [handler];\r\n        }\r\n    }\r\n\r\n    unSubscribeProgress(id, handler) {\r\n        this.progressSubscribers[id] = this.progressSubscribers[id].filter(fun => fun !== handler);\r\n    }\r\n\r\n    setProgress(progress) {\r\n        this.current.progress = progress;\r\n        this.spreadProgressChanges();\r\n    }\r\n\r\n    spreadProgressChanges() {\r\n        const { id, progress } = this.current;\r\n\r\n        for (let handler of this.progressSubscribers['#'] || []) {\r\n            handler(progress);\r\n        }\r\n\r\n        if(!this.progressSubscribers[id]) return;\r\n        for (let handler of this.progressSubscribers[id]) {\r\n            handler(progress);\r\n        }\r\n    }\r\n\r\n    addProgressProvider(id, handler) {\r\n        this.progressProviders[id] = handler;\r\n    }\r\n\r\n    removeProgressProvider(id) {\r\n        delete this.progressProviders[id];\r\n    }\r\n\r\n    getProgress(id) {\r\n        if (!id) {\r\n            return this.getProgress(this.current.id);\r\n        }\r\n\r\n        if(!id || !this.progressProviders[id]){\r\n            return this.current.progress;\r\n        }\r\n\r\n        return this.progressProviders[id]();\r\n    }\r\n\r\n    setBuffered(buffered) {\r\n        if (this.current.id) {\r\n            this.current.buffered = buffered;\r\n        }\r\n        this.spreadBufferChanges();\r\n    }\r\n\r\n    subscribeBuffred(handel) {\r\n        this.bufferedSubscribers.push(handel)\r\n    }\r\n\r\n    unSubscribeBuffered(handler) {\r\n        this.bufferedSubscribers = this.bufferedSubscribers.filter(fun =>\r\n            fun !== handler\r\n        );\r\n    }\r\n\r\n    spreadBufferChanges() {\r\n        for (let handler of this.bufferedSubscribers) {\r\n            handler(this.current.buffered);\r\n        }\r\n    }\r\n}\r\n\r\nexport function usePlayer() {\r\n    const [player,] = useState(new PlayerBus())\r\n\r\n\r\n    useEffect(() => {\r\n        player.mediaElement = player.mediaElement || document.createElement('audio');\r\n        // player.mediaElement.type = \"audio/mp3\";\r\n    }, [player])\r\n\r\n    const startUpdateProg = useCallback(() => {\r\n        const handler = setInterval(() => window.requestIdleCallback( () => {\r\n            \r\n            if(player.current.state === PLAYBACK_STATE.PAUSE){\r\n                clearInterval(handler);\r\n            }\r\n            console.log(player.current)\r\n            const mediaEl = player.mediaElement;\r\n            if(!player.current.duration) {\r\n                player.current.duration = mediaEl.duration * 1000;\r\n            }\r\n            const progress = mediaEl.currentTime / (player.current.duration / 1000);\r\n            player.setProgress(progress);\r\n            //--\r\n            const bufferdTimeRanges = mediaEl.buffered;\r\n            if (bufferdTimeRanges.length) {\r\n                const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                player.setBuffered(end / (player.current.duration / 1000))\r\n            }\r\n        }, {timeout: 20}), 400)\r\n        player.progressUpdaterHandler = handler;\r\n\r\n    }, [player])\r\n\r\n    const stopUpdateProg = useCallback(() => {\r\n        clearInterval(player.progressUpdaterHandler);\r\n    }, [player])\r\n\r\n    useEffect(() => {\r\n        const media = player.mediaElement;\r\n        if (media) {\r\n            media.addEventListener(\"ended\", () => {\r\n                if (player.current.state === PLAYBACK_STATE.PLAY) {\r\n                    player.setCurrent({\r\n                        ...player.current,\r\n                        state: PLAYBACK_STATE.PAUSE,\r\n                    })\r\n                    player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n                }\r\n                stopUpdateProg();\r\n            })\r\n            media.addEventListener('progress', () => {\r\n                const bufferdTimeRanges = media.buffered;\r\n                if (bufferdTimeRanges.length) {\r\n                    const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                    player.setBuffered(end / (player.current.duration / 1000))\r\n                }\r\n            })\r\n        }\r\n    }, [player, stopUpdateProg])\r\n\r\n    const playback = useCallback((id, pbState, source) => {\r\n        id = id || player.current.id;\r\n        source = source || player.current.source || \"RecordsStore\";\r\n        const api = getApi(source);\r\n        const media = player.mediaElement;\r\n        const isCurrent = id === player.current.id;\r\n        \r\n        if (!id) {\r\n            return;\r\n        }\r\n\r\n        console.log(\"playback\", id, pbState, source)\r\n        if (pbState === PLAYBACK_STATE.PLAY) {\r\n            let progress, duration;\r\n            if (isCurrent) {\r\n                ({ progress, duration } = player.getProgress(\"#\"));\r\n            } else {\r\n                ({ progress, duration } = player.getProgress(id));\r\n            }\r\n            const position = (duration / 1000) * progress;\r\n            media.src = api.getStreamUrl(id);\r\n            \r\n            if(!isNaN(position)){\r\n                media.currentTime = position;\r\n            }\r\n            \r\n            media.play().catch(error => {\r\n                Logger.push(Log.Error(\r\n                    ['usePlayer', 'playback method'], \r\n                    'Media element play method error' + error.message,\r\n                    error))\r\n            });\r\n\r\n            if (player.current.id && !isCurrent) {\r\n                player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n            }\r\n\r\n            player.setCurrent({\r\n                id,\r\n                source,\r\n                duration,\r\n                progress,\r\n                buffered: 0,\r\n                state: PLAYBACK_STATE.PLAY,\r\n            })\r\n\r\n            startUpdateProg()\r\n        } else if (pbState === PLAYBACK_STATE.PAUSE) {\r\n            if (media.readyState >= 2) {\r\n                media.pause();\r\n            } else {\r\n                media.load();\r\n            }\r\n\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PAUSE\r\n            })\r\n            stopUpdateProg();\r\n        }\r\n\r\n        if (isCurrent) {\r\n            player.setPlaybackState(id, pbState)\r\n        }\r\n\r\n    }, [player,\r\n        stopUpdateProg,\r\n        startUpdateProg,\r\n    ])\r\n\r\n    const seek = useCallback(({\r\n        id = player.current.id,\r\n        progress,\r\n        duration = player.current.duration,\r\n        source = 'RecordsStore',\r\n    }) => {\r\n        \r\n        const mediaEl = player.mediaElement;\r\n        const api = getApi(source);\r\n\r\n        if (!id || !duration) {\r\n            return;\r\n        }\r\n\r\n        if (player.current.id && player.current.id !== id) {\r\n            player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE);\r\n        }\r\n        const position = (duration / 1000) * progress;\r\n\r\n        if (isNaN(position)) {\r\n            return;\r\n        }\r\n\r\n        stopUpdateProg();\r\n\r\n        if (player.current.id !== id) {\r\n            mediaEl.src = api.getStreamUrl(id);\r\n            mediaEl.currentTime = position;\r\n            player.setPlaybackState(id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                id,\r\n                source,\r\n                duration,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n            player.setProgress(progress);\r\n        }\r\n\r\n        mediaEl.currentTime = position;\r\n        if (mediaEl.pause) {\r\n            mediaEl.play().catch(err => console.log('Play action was aborded' + err));\r\n            player.setPlaybackState(player.current.id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n        }\r\n        startUpdateProg();\r\n    }, [player, stopUpdateProg, startUpdateProg])\r\n\r\n    const setVolume = useCallback((level) => {\r\n        const mediaElement = player.mediaElement;\r\n        if (!mediaElement) {\r\n            return;\r\n        }\r\n        mediaElement.volume = level;\r\n    }, [player])\r\n\r\n    const stop = useCallback(() => {\r\n        const mediaElement = player.mediaElement;\r\n        mediaElement.load();\r\n    }, [player])\r\n\r\n    const controls = {\r\n        playback,\r\n        seek,\r\n        setVolume,\r\n        stop,\r\n    }\r\n\r\n    return [\r\n        controls,\r\n        player\r\n    ]\r\n}"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _slicedToArray from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import debounce from\"lodash/debounce\";import React,{useCallback,useEffect,useMemo,useRef,useState}from\"react\";import WaveSurfer from\"wavesurfer\";import useWindowSize from\"../../../Hooks/useWindowSize\";import style from\"./wave-surfer-player.scss\";var WaveSurferPlayer=function WaveSurferPlayer(_ref){var _ref$record=_ref.record,peaks=_ref$record.peaks,id=_ref$record.id,duration=_ref$record.duration,seek=_ref.seek,player=_ref.player;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),container=_useState2[0],setContainer=_useState2[1];var containerRef=useRef();var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),ws=_useState4[0],setWs=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),progress=_useState6[0],setProgress=_useState6[1];var _progress=useRef();var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),loaded=_useState8[0],setLoaded=_useState8[1];var _useWindowSize=useWindowSize(),_useWindowSize2=_slicedToArray(_useWindowSize,1),windowWidth=_useWindowSize2[0];var cachedWidth=useRef();var getContainerWidth=useCallback(function(){if(!cachedWidth.current){cachedWidth.current=container===null||container===void 0?void 0:container.getBoundingClientRect().width;}return cachedWidth.current;},[container]);var setProgressMiddleware=useCallback(function(progress){setProgress(progress);_progress.current=progress;},[setProgress]);var setContainerRef=useCallback(function(ref){setContainer(ref);containerRef.current=ref;},[setContainer,containerRef]);var drawPeaks=useCallback(function(container,peaks,ws){if(!container||!peaks||!ws){return;}var width=getContainerWidth();var start=0;var end=peaks.length/2;if(window.devicePixelRatio){width*=window.devicePixelRatio;}ws.drawer.drawPeaks(peaks,width,start,end);setLoaded(true);},[setLoaded,getContainerWidth]);useEffect(function(){if(!container||loaded||container.hasChildNodes()||!player){return;}var ws=new Promise(function(res,rej){try{var _ws=WaveSurfer.create({container:container,barWidth:2,height:100,waveColor:style.waveColor,progressColor:style.progressColor,barMinHeight:0,hideScrollbar:true,cursorColor:'transparent'});res(_ws);}catch(err){rej(err);}});ws.then(function(ws){setWs(ws);return ws;});ws.then(function(ws){if(peaks){drawPeaks(container,peaks,ws);if(id===player.getCurrent().id){setProgressMiddleware(player.getCurrent().progress);}setLoaded(true);}if(seek){ws.on('seek',function(progress){seek({id:id,progress:progress,duration:duration});ws.drawer.progress(progress);});}});},[id,seek,peaks,player,duration,container,setProgressMiddleware,setWs,drawPeaks,loaded]);useEffect(function(){if(ws&&progress){ws.drawer.progress(progress);}},[ws,progress]);var getProgressData=useCallback(function(){return{duration:duration,progress:_progress.current||0};},[duration,_progress]);useEffect(function(){if(!player){return;}player.subscribeProgress(id,setProgressMiddleware);player.addProgressProvider(id,getProgressData);return function(){player.unSubscribeProgress(id,setProgressMiddleware);player.removeProgressProvider(id);};},[id,player,getProgressData,setProgressMiddleware]);var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isMounted=_useState10[0],setMounted=_useState10[1];useEffect(function(){setMounted(true);return function(){return setMounted(false);};},[setMounted]);var debouncedUpdate=useMemo(function(){cachedWidth.current=null;return debounce(drawPeaks.bind(null,container,peaks,ws),500);},[ws,peaks,container,drawPeaks,cachedWidth]);useEffect(function(){if(loaded&&container&&isMounted){//debouncedUpdate();\n}},[windowWidth,loaded,debouncedUpdate,isMounted,container]);return React.createElement(\"div\",{key:\"ws\"+id,className:\"ws-player-container\",ref:setContainerRef});};export default WaveSurferPlayer;","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/components/Record/WaveSurrferPlayer/WaveSurferPlayer.js"],"names":["debounce","React","useCallback","useEffect","useMemo","useRef","useState","WaveSurfer","useWindowSize","style","WaveSurferPlayer","record","peaks","id","duration","seek","player","container","setContainer","containerRef","ws","setWs","progress","setProgress","_progress","loaded","setLoaded","windowWidth","cachedWidth","getContainerWidth","current","getBoundingClientRect","width","setProgressMiddleware","setContainerRef","ref","drawPeaks","start","end","length","window","devicePixelRatio","drawer","hasChildNodes","Promise","res","rej","create","barWidth","height","waveColor","progressColor","barMinHeight","hideScrollbar","cursorColor","err","then","getCurrent","on","getProgressData","subscribeProgress","addProgressProvider","unSubscribeProgress","removeProgressProvider","isMounted","setMounted","debouncedUpdate","bind"],"mappings":"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","sourcesContent":["import debounce from \"lodash/debounce\";\r\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport WaveSurfer from \"wavesurfer\";\r\nimport useWindowSize from \"../../../Hooks/useWindowSize\";\r\nimport style from \"./wave-surfer-player.scss\";\r\n\r\nconst WaveSurferPlayer = ({ record: { peaks, id, duration },  seek , player }) => {\r\n    const [container, setContainer] = useState(null);\r\n    const containerRef= useRef();\r\n    const [ws, setWs] = useState(null);\r\n    const [progress, setProgress] = useState(0);\r\n    const _progress = useRef();\r\n    const [loaded, setLoaded] = useState(false);\r\n    const [windowWidth, ] = useWindowSize();\r\n    \r\n    const cachedWidth = useRef();\r\n \r\n    const getContainerWidth = useCallback(()=>{\r\n        if(!cachedWidth.current){\r\n            cachedWidth.current = container?.getBoundingClientRect().width;\r\n        }\r\n        return cachedWidth.current;\r\n    }, [container])\r\n\r\n    const setProgressMiddleware = useCallback((progress)=>{\r\n        setProgress(progress);\r\n        _progress.current = progress;\r\n    },[setProgress])    \r\n\r\n    const setContainerRef = useCallback((ref) => {\r\n        setContainer(ref);\r\n        containerRef.current = ref;\r\n    }, [setContainer, containerRef])\r\n\r\n    const drawPeaks = useCallback((container, peaks, ws) => {\r\n        if(!container || !peaks || !ws   ){\r\n            return;\r\n        }\r\n        let width = getContainerWidth();\r\n        const start = 0;\r\n        const end = peaks.length / 2;\r\n        if (window.devicePixelRatio) {\r\n            width *= window.devicePixelRatio;\r\n        }\r\n        ws.drawer.drawPeaks(peaks, width, start, end);\r\n        setLoaded(true)\r\n    }, [setLoaded, getContainerWidth])\r\n\r\n    useEffect(() => {\r\n        if(!container || loaded || container.hasChildNodes() || !player){\r\n            return;\r\n        }\r\n\r\n        const ws = new Promise((res, rej) => {\r\n            try {\r\n                const ws = WaveSurfer.create({\r\n                    container: container,\r\n                    barWidth: 2,\r\n                    height: 100,\r\n                    waveColor: style.waveColor,\r\n                    progressColor: style.progressColor,\r\n                    barMinHeight: 0,\r\n                    hideScrollbar: true,\r\n                    cursorColor: 'transparent'\r\n                })\r\n                res(ws)\r\n            } catch (err) {\r\n                rej(err)\r\n            }\r\n        })\r\n        ws.then(ws => {\r\n            setWs(ws);\r\n            return ws;\r\n        })\r\n\r\n        ws.then((ws) => {\r\n            if (peaks) {\r\n                drawPeaks(container, peaks, ws);\r\n                if(id === player.getCurrent().id){\r\n                    setProgressMiddleware(player.getCurrent().progress)\r\n                }\r\n                setLoaded(true)\r\n            }\r\n            if (seek) {\r\n                ws.on('seek', (progress) => {\r\n                    seek({\r\n                        id,\r\n                        progress,\r\n                        duration,\r\n                    })\r\n                    ws.drawer.progress(progress);\r\n                })\r\n            }\r\n        })\r\n        \r\n    }, [\r\n        id, \r\n        seek,\r\n        peaks,\r\n        player,\r\n        duration, \r\n        container,\r\n        setProgressMiddleware, \r\n        setWs, \r\n        drawPeaks, \r\n        loaded])\r\n\r\n\r\n\r\n    useEffect(() => {\r\n        if (ws && progress) {\r\n            ws.drawer.progress(progress);\r\n        }\r\n    }, [ws, progress])\r\n\r\n    const getProgressData = useCallback(() => {\r\n        return {\r\n            duration,\r\n            progress: _progress.current || 0,\r\n        }\r\n    }, [duration, _progress])\r\n\r\n    useEffect(() => {\r\n        if (!player) {\r\n            return;\r\n        }\r\n        player.subscribeProgress(id, setProgressMiddleware);\r\n        player.addProgressProvider(id, getProgressData);\r\n        return () => {\r\n            player.unSubscribeProgress(id, setProgressMiddleware);\r\n            player.removeProgressProvider(id);\r\n        }\r\n    }, [id, player, getProgressData, setProgressMiddleware])\r\n\r\n\r\n    const [isMounted, setMounted] = useState(false);\r\n    useEffect(()=>{\r\n        setMounted(true);\r\n        return () => setMounted(false);\r\n    }, [setMounted])\r\n\r\n    const debouncedUpdate = useMemo(()=>{\r\n        cachedWidth.current = null\r\n        return debounce(drawPeaks.bind(null, container, peaks, ws), 500)\r\n    }, [ws, peaks , container, drawPeaks, cachedWidth])\r\n\r\n    useEffect(()=>{\r\n        if(loaded && container && isMounted){\r\n            //debouncedUpdate();\r\n        }\r\n    }, [windowWidth, loaded, debouncedUpdate, isMounted, container])\r\n\r\n    return (\r\n        <div key={\"ws\" + id} className=\"ws-player-container\" ref={setContainerRef} />\r\n    )\r\n}\r\n\r\nexport default WaveSurferPlayer"]},"metadata":{},"sourceType":"module"}
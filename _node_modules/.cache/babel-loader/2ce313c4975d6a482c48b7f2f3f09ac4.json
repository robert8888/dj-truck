{"ast":null,"code":"import _objectSpread from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _classCallCheck from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import{useCallback,useEffect,useState}from\"react\";import{Log,Logger}from\"../../../utils/logger/logger\";import{getApi}from\"./../../../apis/apiProvider\";import{PLAYBACK_STATE}from\"./usePlabackState\";//getRecordUrl\nvar PlayerBus=/*#__PURE__*/function(){function PlayerBus(){_classCallCheck(this,PlayerBus);this.progressUpdaterHandler=null;this.current={id:null,source:\"RecordsStore\",start:0,duration:0,progress:0,state:null,buffered:0};this.playbackSubscirbers={};this.progressSubscribers={};this.bufferedSubscribers=[];this.progressProviders={};this.currentSubscribers=[];if(!PlayerBus.instance){PlayerBus.instance=this;}return PlayerBus.instance;}_createClass(PlayerBus,[{key:\"setCurrent\",value:function setCurrent(nextCurrent){this.current=nextCurrent;this.spreadCurrentChange();}},{key:\"subscribeCurrent\",value:function subscribeCurrent(handler){this.currentSubscribers.push(handler);handler(this.current);}},{key:\"unSubscribeCurrent\",value:function unSubscribeCurrent(handler){this.currentSubscribers=this.currentSubscribers.filter(function(fun){return!fun===handler;});}},{key:\"spreadCurrentChange\",value:function spreadCurrentChange(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.currentSubscribers[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var handler=_step.value;handler(this.current);}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return!=null){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}},{key:\"getCurrent\",value:function getCurrent(){return this.current;}},{key:\"subscribePlayback\",value:function subscribePlayback(id,handler){this.playbackSubscirbers[id]=handler;}},{key:\"unSubscribePlayback\",value:function unSubscribePlayback(id){delete this.playbackSubscirbers[id];}},{key:\"setPlaybackState\",value:function setPlaybackState(id,state){if(this.playbackSubscirbers[id]){this.playbackSubscirbers[id](state);}}},{key:\"subscribeProgress\",value:function subscribeProgress(id,handler){if(this.progressSubscribers[id]){this.progressSubscribers[id].push(handler);}else{this.progressSubscribers[id]=[handler];}}},{key:\"unSubscribeProgress\",value:function unSubscribeProgress(id,handler){this.progressSubscribers[id]=this.progressSubscribers[id].filter(function(fun){return fun!==handler;});}},{key:\"setProgress\",value:function setProgress(progress){this.current.progress=progress;this.spreadProgressChanges();}},{key:\"spreadProgressChanges\",value:function spreadProgressChanges(){var _this$current=this.current,id=_this$current.id,progress=_this$current.progress;var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=(this.progressSubscribers['#']||[])[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var handler=_step2.value;handler(progress);}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return!=null){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}if(!this.progressSubscribers[id])return;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.progressSubscribers[id][Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var _handler=_step3.value;_handler(progress);}}catch(err){_didIteratorError3=true;_iteratorError3=err;}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return!=null){_iterator3.return();}}finally{if(_didIteratorError3){throw _iteratorError3;}}}}},{key:\"addProgressProvider\",value:function addProgressProvider(id,handler){this.progressProviders[id]=handler;}},{key:\"removeProgressProvider\",value:function removeProgressProvider(id){delete this.progressProviders[id];}},{key:\"getProgress\",value:function getProgress(id){if(!id){return this.getProgress(this.current.id);}if(!id||!this.progressProviders[id]){return this.current.progress;}return this.progressProviders[id]();}},{key:\"setBuffered\",value:function setBuffered(buffered){if(this.current.id){this.current.buffered=buffered;}this.spreadBufferChanges();}},{key:\"subscribeBuffred\",value:function subscribeBuffred(handel){this.bufferedSubscribers.push(handel);}},{key:\"unSubscribeBuffered\",value:function unSubscribeBuffered(handler){this.bufferedSubscribers=this.bufferedSubscribers.filter(function(fun){return fun!==handler;});}},{key:\"spreadBufferChanges\",value:function spreadBufferChanges(){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this.bufferedSubscribers[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var handler=_step4.value;handler(this.current.buffered);}}catch(err){_didIteratorError4=true;_iteratorError4=err;}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return!=null){_iterator4.return();}}finally{if(_didIteratorError4){throw _iteratorError4;}}}}}]);return PlayerBus;}();export function usePlayer(){var _useState=useState(new PlayerBus()),_useState2=_slicedToArray(_useState,1),player=_useState2[0];useEffect(function(){player.mediaElement=player.mediaElement||document.createElement('audio');// player.mediaElement.type = \"audio/mp3\";\n},[player]);var startUpdateProg=useCallback(function(){var handler=setInterval(function(){return window.requestIdleCallback(function(){if(player.current.state===PLAYBACK_STATE.PAUSE){clearInterval(handler);}var mediaEl=player.mediaElement;if(!player.current.duration){player.setCurrent(_objectSpread({},player.current,{duration:mediaEl.duration*1000}));}var progress=mediaEl.currentTime/(player.current.duration/1000);player.setProgress(progress);//--\nvar bufferdTimeRanges=mediaEl.buffered;if(bufferdTimeRanges.length){var end=bufferdTimeRanges.end(bufferdTimeRanges.length-1);player.setBuffered(end/(player.current.duration/1000));}},{timeout:20});},400);player.progressUpdaterHandler=handler;},[player]);var stopUpdateProg=useCallback(function(){clearInterval(player.progressUpdaterHandler);},[player]);useEffect(function(){var media=player.mediaElement;if(media){media.addEventListener(\"ended\",function(){if(player.current.state===PLAYBACK_STATE.PLAY){player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PAUSE}));player.setPlaybackState(player.current.id,PLAYBACK_STATE.PAUSE);}stopUpdateProg();});media.addEventListener('progress',function(){var bufferdTimeRanges=media.buffered;if(bufferdTimeRanges.length){var end=bufferdTimeRanges.end(bufferdTimeRanges.length-1);player.setBuffered(end/(player.current.duration/1000));}});}},[player,stopUpdateProg]);var playback=useCallback(function(id,pbState,source){id=id||player.current.id;source=source||player.current.source||\"RecordsStore\";var api=getApi(source);var media=player.mediaElement;var isCurrent=id===player.current.id;if(!id){return;}if(pbState===PLAYBACK_STATE.PLAY){var progress,duration;if(isCurrent){var _player$getProgress=player.getProgress(\"#\");progress=_player$getProgress.progress;duration=_player$getProgress.duration;}else{var _player$getProgress2=player.getProgress(id);progress=_player$getProgress2.progress;duration=_player$getProgress2.duration;}var position=duration/1000*progress;media.src=api.getStreamUrl(id);if(!isNaN(position)){media.currentTime=position;}media.play().catch(function(error){Logger.push(Log.Error(['usePlayer','playback method'],'Media element play method error'+error.message,error));});if(player.current.id&&!isCurrent){player.setPlaybackState(player.current.id,PLAYBACK_STATE.PAUSE);}player.setCurrent({id:id,source:source,duration:duration,progress:progress,buffered:0,state:PLAYBACK_STATE.PLAY});startUpdateProg();}else if(pbState===PLAYBACK_STATE.PAUSE){if(media.readyState>=2){media.pause();}else{media.load();}player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PAUSE}));stopUpdateProg();}if(isCurrent){player.setPlaybackState(id,pbState);}},[player,stopUpdateProg,startUpdateProg]);var seek=useCallback(function(_ref){var _ref$id=_ref.id,id=_ref$id===void 0?player.current.id:_ref$id,progress=_ref.progress,_ref$duration=_ref.duration,duration=_ref$duration===void 0?player.current.duration:_ref$duration,_ref$source=_ref.source,source=_ref$source===void 0?'RecordsStore':_ref$source;var mediaEl=player.mediaElement;var api=getApi(source);if(!id||!duration){return;}if(player.current.id&&player.current.id!==id){player.setPlaybackState(player.current.id,PLAYBACK_STATE.PAUSE);}var position=duration/1000*progress;if(isNaN(position)){return;}stopUpdateProg();if(player.current.id!==id){mediaEl.src=api.getStreamUrl(id);mediaEl.currentTime=position;player.setPlaybackState(id,PLAYBACK_STATE.PLAY);player.setCurrent(_objectSpread({},player.current,{id:id,source:source,duration:duration,state:PLAYBACK_STATE.PLAY}));player.setProgress(progress);}mediaEl.currentTime=position;if(mediaEl.pause){mediaEl.play().catch(function(err){return console.log('Play action was aborded'+err);});player.setPlaybackState(player.current.id,PLAYBACK_STATE.PLAY);player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PLAY}));}startUpdateProg();},[player,stopUpdateProg,startUpdateProg]);var setVolume=useCallback(function(level){var mediaElement=player.mediaElement;if(!mediaElement){return;}mediaElement.volume=level;},[player]);var stop=useCallback(function(){var mediaElement=player.mediaElement;mediaElement.load();player.setCurrent(_objectSpread({},player.current,{state:PLAYBACK_STATE.PAUSE}));},[player]);var controls={playback:playback,seek:seek,setVolume:setVolume,stop:stop};return[controls,player];}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/Hooks/usePlayer.js"],"names":["useCallback","useEffect","useState","Log","Logger","getApi","PLAYBACK_STATE","PlayerBus","progressUpdaterHandler","current","id","source","start","duration","progress","state","buffered","playbackSubscirbers","progressSubscribers","bufferedSubscribers","progressProviders","currentSubscribers","instance","nextCurrent","spreadCurrentChange","handler","push","filter","fun","spreadProgressChanges","getProgress","spreadBufferChanges","handel","usePlayer","player","mediaElement","document","createElement","startUpdateProg","setInterval","window","requestIdleCallback","PAUSE","clearInterval","mediaEl","setCurrent","currentTime","setProgress","bufferdTimeRanges","length","end","setBuffered","timeout","stopUpdateProg","media","addEventListener","PLAY","setPlaybackState","playback","pbState","api","isCurrent","position","src","getStreamUrl","isNaN","play","catch","error","Error","message","readyState","pause","load","seek","err","console","log","setVolume","level","volume","stop","controls"],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\r\nimport { Log, Logger } from \"../../../utils/logger/logger\";\r\nimport { getApi } from \"./../../../apis/apiProvider\";\r\nimport { PLAYBACK_STATE } from \"./usePlabackState\";\r\n\r\n//getRecordUrl\r\nclass PlayerBus {\r\n    constructor() {\r\n        if (!PlayerBus.instance) {\r\n            PlayerBus.instance = this;\r\n        }\r\n\r\n        return PlayerBus.instance;\r\n    }\r\n\r\n\r\n    progressUpdaterHandler = null;\r\n\r\n    current = {\r\n        id: null,\r\n        source: \"RecordsStore\",\r\n        start: 0,\r\n        duration: 0,\r\n        progress: 0,\r\n        state: null,\r\n        buffered: 0,\r\n    };\r\n\r\n    playbackSubscirbers = {}\r\n    progressSubscribers = {}\r\n    bufferedSubscribers = []\r\n    progressProviders = {};\r\n    currentSubscribers = [];\r\n\r\n    setCurrent(nextCurrent) {\r\n        this.current = nextCurrent;\r\n        this.spreadCurrentChange();\r\n    }\r\n\r\n    subscribeCurrent(handler) {\r\n        this.currentSubscribers.push(handler)\r\n        handler(this.current)\r\n    }\r\n\r\n    unSubscribeCurrent(handler) {\r\n        this.currentSubscribers = this.currentSubscribers.filter(fun => !fun === handler);\r\n    }\r\n\r\n    spreadCurrentChange() {\r\n        for (let handler of this.currentSubscribers) {\r\n            handler(this.current);\r\n        }\r\n    }\r\n\r\n    getCurrent() {\r\n        return this.current;\r\n    }\r\n\r\n    subscribePlayback(id, handler) {\r\n        this.playbackSubscirbers[id] = handler;\r\n    }\r\n\r\n    unSubscribePlayback(id) {\r\n        delete this.playbackSubscirbers[id]\r\n    }\r\n\r\n    setPlaybackState(id, state) {\r\n        if (this.playbackSubscirbers[id]) {\r\n            this.playbackSubscirbers[id](state)\r\n        }\r\n    }\r\n\r\n\r\n    subscribeProgress(id, handler) {\r\n        if (this.progressSubscribers[id]) {\r\n            this.progressSubscribers[id].push(handler);\r\n\r\n        } else {\r\n            this.progressSubscribers[id] = [handler];\r\n        }\r\n    }\r\n\r\n    unSubscribeProgress(id, handler) {\r\n        this.progressSubscribers[id] = this.progressSubscribers[id].filter(fun => fun !== handler);\r\n    }\r\n\r\n    setProgress(progress) {\r\n        this.current.progress = progress;\r\n        this.spreadProgressChanges();\r\n    }\r\n\r\n    spreadProgressChanges() {\r\n        const { id, progress } = this.current;\r\n\r\n        for (let handler of this.progressSubscribers['#'] || []) {\r\n            handler(progress);\r\n        }\r\n\r\n        if(!this.progressSubscribers[id]) return;\r\n        for (let handler of this.progressSubscribers[id]) {\r\n            handler(progress);\r\n        }\r\n    }\r\n\r\n    addProgressProvider(id, handler) {\r\n        this.progressProviders[id] = handler;\r\n    }\r\n\r\n    removeProgressProvider(id) {\r\n        delete this.progressProviders[id];\r\n    }\r\n\r\n    getProgress(id) {\r\n        if (!id) {\r\n            return this.getProgress(this.current.id);\r\n        }\r\n\r\n        if(!id || !this.progressProviders[id]){\r\n            return this.current.progress;\r\n        }\r\n\r\n        return this.progressProviders[id]();\r\n    }\r\n\r\n    setBuffered(buffered) {\r\n        if (this.current.id) {\r\n            this.current.buffered = buffered;\r\n        }\r\n        this.spreadBufferChanges();\r\n    }\r\n\r\n    subscribeBuffred(handel) {\r\n        this.bufferedSubscribers.push(handel)\r\n    }\r\n\r\n    unSubscribeBuffered(handler) {\r\n        this.bufferedSubscribers = this.bufferedSubscribers.filter(fun =>\r\n            fun !== handler\r\n        );\r\n    }\r\n\r\n    spreadBufferChanges() {\r\n        for (let handler of this.bufferedSubscribers) {\r\n            handler(this.current.buffered);\r\n        }\r\n    }\r\n}\r\n\r\nexport function usePlayer() {\r\n    const [player,] = useState(new PlayerBus())\r\n\r\n\r\n    useEffect(() => {\r\n        player.mediaElement = player.mediaElement || document.createElement('audio');\r\n        // player.mediaElement.type = \"audio/mp3\";\r\n    }, [player])\r\n\r\n    const startUpdateProg = useCallback(() => {\r\n        const handler = setInterval(() => window.requestIdleCallback( () => {\r\n            \r\n            if(player.current.state === PLAYBACK_STATE.PAUSE){\r\n                clearInterval(handler);\r\n            }\r\n            const mediaEl = player.mediaElement;\r\n            if(!player.current.duration) {\r\n                player.setCurrent({\r\n                    ...player.current,\r\n                    duration : mediaEl.duration * 1000\r\n                })\r\n            }\r\n            const progress = mediaEl.currentTime / (player.current.duration / 1000);\r\n            player.setProgress(progress);\r\n            //--\r\n            const bufferdTimeRanges = mediaEl.buffered;\r\n            if (bufferdTimeRanges.length) {\r\n                const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                player.setBuffered(end / (player.current.duration / 1000))\r\n            }\r\n        }, {timeout: 20}), 400)\r\n        player.progressUpdaterHandler = handler;\r\n\r\n    }, [player])\r\n\r\n    const stopUpdateProg = useCallback(() => {\r\n        clearInterval(player.progressUpdaterHandler);\r\n    }, [player])\r\n\r\n    useEffect(() => {\r\n        const media = player.mediaElement;\r\n        if (media) {\r\n            media.addEventListener(\"ended\", () => {\r\n                if (player.current.state === PLAYBACK_STATE.PLAY) {\r\n                    player.setCurrent({\r\n                        ...player.current,\r\n                        state: PLAYBACK_STATE.PAUSE,\r\n                    })\r\n                    player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n                }\r\n                stopUpdateProg();\r\n            })\r\n            media.addEventListener('progress', () => {\r\n                const bufferdTimeRanges = media.buffered;\r\n                if (bufferdTimeRanges.length) {\r\n                    const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\r\n                    player.setBuffered(end / (player.current.duration / 1000))\r\n                }\r\n            })\r\n        }\r\n    }, [player, stopUpdateProg])\r\n\r\n    const playback = useCallback((id, pbState, source) => {\r\n        id = id || player.current.id;\r\n        source = source || player.current.source || \"RecordsStore\";\r\n        const api = getApi(source);\r\n        const media = player.mediaElement;\r\n        const isCurrent = id === player.current.id;\r\n        \r\n        if (!id) {\r\n            return;\r\n        }\r\n\r\n        if (pbState === PLAYBACK_STATE.PLAY) {\r\n            let progress, duration;\r\n            if (isCurrent) {\r\n                ({ progress, duration } = player.getProgress(\"#\"));\r\n            } else {\r\n                ({ progress, duration } = player.getProgress(id));\r\n            }\r\n            const position = (duration / 1000) * progress;\r\n            media.src = api.getStreamUrl(id);\r\n            \r\n            if(!isNaN(position)){\r\n                media.currentTime = position;\r\n            }\r\n            \r\n            media.play().catch(error => {\r\n                Logger.push(Log.Error(\r\n                    ['usePlayer', 'playback method'], \r\n                    'Media element play method error' + error.message,\r\n                    error))\r\n            });\r\n\r\n            if (player.current.id && !isCurrent) {\r\n                player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE)\r\n            }\r\n\r\n            player.setCurrent({\r\n                id,\r\n                source,\r\n                duration,\r\n                progress,\r\n                buffered: 0,\r\n                state: PLAYBACK_STATE.PLAY,\r\n            })\r\n\r\n            startUpdateProg()\r\n        } else if (pbState === PLAYBACK_STATE.PAUSE) {\r\n            if (media.readyState >= 2) {\r\n                media.pause();\r\n            } else {\r\n                media.load();\r\n            }\r\n\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PAUSE\r\n            })\r\n            stopUpdateProg();\r\n        }\r\n\r\n        if (isCurrent) {\r\n            player.setPlaybackState(id, pbState)\r\n        }\r\n\r\n    }, [player,\r\n        stopUpdateProg,\r\n        startUpdateProg,\r\n    ])\r\n\r\n    const seek = useCallback(({\r\n        id = player.current.id,\r\n        progress,\r\n        duration = player.current.duration,\r\n        source = 'RecordsStore',\r\n    }) => {\r\n        \r\n        const mediaEl = player.mediaElement;\r\n        const api = getApi(source);\r\n\r\n        if (!id || !duration) {\r\n            return;\r\n        }\r\n\r\n        if (player.current.id && player.current.id !== id) {\r\n            player.setPlaybackState(player.current.id, PLAYBACK_STATE.PAUSE);\r\n        }\r\n        const position = (duration / 1000) * progress;\r\n\r\n        if (isNaN(position)) {\r\n            return;\r\n        }\r\n\r\n        stopUpdateProg();\r\n\r\n        if (player.current.id !== id) {\r\n            mediaEl.src = api.getStreamUrl(id);\r\n            mediaEl.currentTime = position;\r\n            player.setPlaybackState(id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                id,\r\n                source,\r\n                duration,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n            player.setProgress(progress);\r\n        }\r\n\r\n        mediaEl.currentTime = position;\r\n        if (mediaEl.pause) {\r\n            mediaEl.play().catch(err => console.log('Play action was aborded' + err));\r\n            player.setPlaybackState(player.current.id, PLAYBACK_STATE.PLAY);\r\n            player.setCurrent({\r\n                ...player.current,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n        }\r\n        startUpdateProg();\r\n    }, [player, stopUpdateProg, startUpdateProg])\r\n\r\n    const setVolume = useCallback((level) => {\r\n        const mediaElement = player.mediaElement;\r\n        if (!mediaElement) {\r\n            return;\r\n        }\r\n        mediaElement.volume = level;\r\n    }, [player])\r\n\r\n    const stop = useCallback(() => {\r\n        const mediaElement = player.mediaElement;\r\n        mediaElement.load();\r\n        player.setCurrent({\r\n            ...player.current,\r\n            state:PLAYBACK_STATE.PAUSE,\r\n        })\r\n    }, [player])\r\n\r\n    const controls = {\r\n        playback,\r\n        seek,\r\n        setVolume,\r\n        stop,\r\n    }\r\n\r\n    return [\r\n        controls,\r\n        player\r\n    ]\r\n}"]},"metadata":{},"sourceType":"module"}
{"ast":null,"code":"import _objectSpread from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"D:\\\\PROJEKTY\\\\APKI\\\\dj-truck\\\\node_modules\\\\@babel\\\\runtime/regenerator\";var _marked=/*#__PURE__*/_regeneratorRuntime.mark(pushTrackToListSaga),_marked2=/*#__PURE__*/_regeneratorRuntime.mark(handle);import{get}from\"lodash/object\";import{hideLoading,showLoading}from'react-redux-loading-bar';import{call,put,select,takeEvery}from\"redux-saga/effects\";import UUID from\"uuidjs\";import{ACTIONS,pushLog,pushTrackToList,startCalcBpm}from\"../../actions\";import{getApi}from\"./../../apis/apiProvider\";import{Log}from\"./../../utils/logger/logger\";import errorParser from\"./../../utils/serverErrorParser/errorParser\";import{formater}from\"./../../utils/time/timeFromater\";import{handle as createNewPlaylist}from\"./reqCreatePlaylistSaga\";export default function pushTrackToListSaga(){return _regeneratorRuntime.wrap(function pushTrackToListSaga$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return takeEvery(ACTIONS.PL_PUSH_TRACK_REQUEST,handle);case 2:case\"end\":return _context.stop();}}},_marked);}var getToken=function getToken(state){return state.user.token;};var getPlaylistPath=function getPlaylistPath(state){return state.playList.currentPlaylist;};var getCurrent=function getCurrent(state,path){return get(state.playList,state.playList.currentPlaylist);};function handle(action){var path,token,_currentPlaylist$_con,_getApi,callQuery,queries,currentPlaylist,playlistId,playlistLength,response,trackId,currentPlaylistPath;return _regeneratorRuntime.wrap(function handle$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:path=['saga','playlist','request add track to playlist'];_context2.next=3;return select(getToken);case 3:token=_context2.sent;if(token){_context2.next=11;break;}action.track.id=UUID.genV1().toString();_context2.next=8;return put(pushTrackToList(action.track,action.playlist));case 8:_context2.next=10;return put(startCalcBpm(action.track,action.playlist));case 10:return _context2.abrupt(\"return\");case 11:_context2.prev=11;_context2.next=14;return put(showLoading());case 14:_getApi=getApi(\"UserAssets\"),callQuery=_getApi.callQuery,queries=_getApi.queries;_context2.next=17;return select(getCurrent);case 17:currentPlaylist=_context2.sent;playlistId=currentPlaylist===null||currentPlaylist===void 0?void 0:currentPlaylist._id;playlistLength=currentPlaylist===null||currentPlaylist===void 0?void 0:(_currentPlaylist$_con=currentPlaylist._content)===null||_currentPlaylist$_con===void 0?void 0:_currentPlaylist$_con.length;if(playlistId){_context2.next=25;break;}_context2.next=23;return call(createNewPlaylist,{setCurrent:true,renameMode:false});case 23:playlistId=_context2.sent;playlistLength=0;case 25:_context2.next=27;return callQuery(queries.createTrackQl,token,{playlist:playlistId,title:action.track.title,source:action.track.source,sourceId:action.track.sourceId.toString(),quality:action.track.quality,duration:typeof action.track.duration===\"string\"?formater.ytToSeconds(action.track.duration):action.track.duration,thumbnails:action.track.thumbnails,position:playlistLength});case 27:response=_context2.sent;if(!response.errors){_context2.next=30;break;}throw new Error('Server response contains errors '+errorParser(response.errors));case 30:trackId=response.data.createTrack.id;_context2.next=33;return put(pushTrackToList(_objectSpread({},action.track,{id:trackId}),action.playlist));case 33:_context2.next=35;return select(getPlaylistPath);case 35:currentPlaylistPath=_context2.sent;action.track.id=trackId;_context2.next=39;return put(startCalcBpm(action.track,currentPlaylistPath));case 39:_context2.next=41;return put(pushLog(new Log(\"Added track id:\".concat(action.track.id,\"to playlist id:\").concat(playlistId,\" successful\"),path)));case 41:_context2.next=47;break;case 43:_context2.prev=43;_context2.t0=_context2[\"catch\"](11);_context2.next=47;return put(pushLog(Log.Error(path,\"Can't track to playlist \"+_context2.t0.message,\"Sorry. During process of adding track to playlist occurred a problem\",_context2.t0)));case 47:_context2.prev=47;_context2.next=50;return put(hideLoading());case 50:return _context2.finish(47);case 51:case\"end\":return _context2.stop();}}},_marked2,null,[[11,43,47,51]]);}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/sagas/playlists/reqAddTrackSaga.js"],"names":["pushTrackToListSaga","handle","get","hideLoading","showLoading","call","put","select","takeEvery","UUID","ACTIONS","pushLog","pushTrackToList","startCalcBpm","getApi","Log","errorParser","formater","createNewPlaylist","PL_PUSH_TRACK_REQUEST","getToken","state","user","token","getPlaylistPath","playList","currentPlaylist","getCurrent","path","action","track","id","genV1","toString","playlist","callQuery","queries","playlistId","_id","playlistLength","_content","length","setCurrent","renameMode","createTrackQl","title","source","sourceId","quality","duration","ytToSeconds","thumbnails","position","response","errors","Error","trackId","data","createTrack","currentPlaylistPath","message"],"mappings":"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","sourcesContent":["import { get } from \"lodash/object\";\r\nimport { hideLoading, showLoading } from 'react-redux-loading-bar';\r\nimport { call, put, select, takeEvery } from \"redux-saga/effects\";\r\nimport UUID from \"uuidjs\";\r\nimport { ACTIONS, pushLog, pushTrackToList, startCalcBpm } from \"../../actions\";\r\nimport { getApi } from \"./../../apis/apiProvider\";\r\nimport { Log } from \"./../../utils/logger/logger\";\r\nimport errorParser from \"./../../utils/serverErrorParser/errorParser\";\r\nimport { formater } from \"./../../utils/time/timeFromater\";\r\nimport { handle as createNewPlaylist } from \"./reqCreatePlaylistSaga\";\r\n\r\nexport default function* pushTrackToListSaga() {\r\n    yield takeEvery(ACTIONS.PL_PUSH_TRACK_REQUEST, handle)\r\n}\r\n\r\nconst getToken = state => state.user.token;\r\n\r\nconst getPlaylistPath = state => state.playList.currentPlaylist;\r\n\r\nconst getCurrent = (state, path) => get(state.playList, state.playList.currentPlaylist);\r\n\r\nfunction* handle(action) {\r\n    const path = ['saga', 'playlist', 'request add track to playlist'];\r\n    const token = yield select(getToken);\r\n\r\n    if (!token) {\r\n        action.track.id = UUID.genV1().toString();\r\n        yield put(pushTrackToList(action.track, action.playlist));\r\n        yield put(startCalcBpm(action.track, action.playlist));\r\n        return;\r\n    }\r\n\r\n    try {\r\n        yield put(showLoading());\r\n        const { callQuery, queries } = getApi(\"UserAssets\");\r\n        const currentPlaylist = yield select(getCurrent);\r\n        let playlistId = currentPlaylist?._id;\r\n        let playlistLength = currentPlaylist?._content?.length;\r\n\r\n        if (!playlistId) {\r\n            playlistId = yield call(createNewPlaylist, { setCurrent: true, renameMode: false });\r\n            playlistLength = 0;\r\n        }\r\n\r\n        const response = yield callQuery(queries.createTrackQl, token, {\r\n            playlist: playlistId,\r\n            title: action.track.title,\r\n            source: action.track.source,\r\n            sourceId: action.track.sourceId.toString(),\r\n            quality: action.track.quality,\r\n            duration: (typeof action.track.duration === \"string\") ?\r\n                formater.ytToSeconds(action.track.duration) :\r\n                action.track.duration,\r\n            thumbnails: action.track.thumbnails,\r\n            position: playlistLength,\r\n        });\r\n\r\n        if(response.errors){\r\n            throw new Error('Server response contains errors '+ errorParser(response.errors))\r\n        }\r\n\r\n        const trackId = response.data.createTrack.id;\r\n        yield put(pushTrackToList({\r\n            ...action.track,\r\n            id: trackId\r\n        }, action.playlist));\r\n\r\n        const currentPlaylistPath = yield select(getPlaylistPath);\r\n        action.track.id = trackId;\r\n        yield put(startCalcBpm(action.track, currentPlaylistPath));\r\n\r\n\r\n        yield put(pushLog(\r\n            new Log(`Added track id:${action.track.id}to playlist id:${playlistId} successful`, path)\r\n        ))\r\n    } catch (error) {\r\n        yield put(pushLog(Log.Error(\r\n            path,\r\n            \"Can't track to playlist \" + error.message,\r\n            \"Sorry. During process of adding track to playlist occurred a problem\",\r\n            error\r\n        )))\r\n    } finally {\r\n        yield put(hideLoading())\r\n    }\r\n}\r\n\r\n"]},"metadata":{},"sourceType":"module"}
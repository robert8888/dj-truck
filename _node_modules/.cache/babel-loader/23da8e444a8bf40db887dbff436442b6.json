{"ast":null,"code":"import React, { useMemo, useState, useEffect, useCallback, useContext } from \"react\";\nimport { getApi } from \"./../../../../apis/apiProvider\";\nimport { PLAYBACK_STATE } from \"./ListItem/PlaybackButton/PlaybackButton\"; //getRecordUrl\n\nexport const PlayerContext = React.createContext({\n  btnStateHandlers: {},\n  setProgressHandlers: [],\n  getProgressDataHandler: [],\n  progressUpdaterHandler: null,\n  current: {\n    id: null,\n    start: 0,\n    duration: 0,\n    progress: 0,\n    state: null\n  },\n\n  setBtnCtrlHandler(id, handler) {\n    this.btnStateHandlers[id] = handler;\n  },\n\n  setBtnState(id, state) {\n    this.btnStateHandlers[id](state);\n  },\n\n  setProgressHandler(id, handler) {\n    if (this.setProgressHandlers[id]) {\n      this.setProgressHandlers[id].push(handler);\n    }\n\n    this.setProgressHandlers[id] = [handler];\n  },\n\n  setProgress(id, progress) {\n    for (let handler of this.setProgressHandlers[id]) {\n      handler(progress);\n    }\n\n    this.current.progress = progress;\n  },\n\n  setProgressDataHandler(id, handler) {\n    this.getProgressDataHandler[id] = handler;\n  },\n\n  getProgress(id) {\n    return this.getProgressDataHandler[id]();\n  },\n\n  externalControler: {\n    current: this.current,\n\n    playback(state) {},\n\n    seek() {},\n\n    volume() {}\n\n  }\n});\nexport function useRecordPlayer() {\n  const [mediaElement, setMediaElement] = useState(null); // const [current, setCurrent] = useState(null);\n  // const [currentStart, setCurrentStart] = useState(0);\n\n  const [progressUpdater, setProgressUpdater] = useState(null);\n  const ctx = useContext(PlayerContext);\n  const api = useMemo(() => {\n    return getApi('RecordsStore');\n  }, [getApi]);\n  useEffect(() => {\n    const medEl = document.createElement('audio');\n    medEl.autoplay = true;\n    medEl.preload = 'metadata';\n    setMediaElement(medEl);\n    ctx.mediaElement = medEl;\n  }, [setMediaElement, ctx]);\n  const startUpdateProg = useCallback(() => {\n    const handler = setInterval(() => {\n      const current = ctx.current;\n\n      if (!current.id || !current.duration) {\n        return;\n      }\n\n      const startTime = current.start * (current.duration / 1000);\n      const currTime = startTime + mediaElement.currentTime;\n      const progress = currTime / (current.duration / 1000);\n      ctx.setProgress(current.id, progress);\n    }, 200);\n    ctx.progressUpdaterHandler = handler;\n  }, [setProgressUpdater, mediaElement, ctx]);\n  const stopUpdateProg = useCallback(() => {\n    clearInterval(ctx.progressUpdaterHandler);\n  }, [ctx]);\n  const playback = useCallback((id, pbState) => {\n    if (pbState === PLAYBACK_STATE.PLAY) {\n      const {\n        progress,\n        duration,\n        filePosition\n      } = ctx.getProgress(id);\n      mediaElement.src = api.getRecordUrl(id, filePosition);\n      mediaElement.play();\n\n      if (ctx.current.id) {\n        ctx.setBtnState(ctx.current.id, PLAYBACK_STATE.PAUSE);\n      }\n\n      ctx.current = {\n        id,\n        duration,\n        start: progress,\n        progress: progress,\n        state: PLAYBACK_STATE.PLAY\n      };\n      startUpdateProg();\n    } else if (pbState === PLAYBACK_STATE.PAUSE) {\n      mediaElement.pause();\n      ctx.current.state = PLAYBACK_STATE.PAUSE;\n      stopUpdateProg();\n    }\n  }, [mediaElement, api, ctx, stopUpdateProg, startUpdateProg]);\n  const seek = useCallback(({\n    id,\n    filePosition,\n    progress,\n    duration\n  }) => {\n    stopUpdateProg();\n\n    if (ctx.current.id && ctx.current.id !== id) {\n      ctx.setBtnState(ctx.current.id, PLAYBACK_STATE.PAUSE);\n    }\n\n    mediaElement.src = api.getRecordUrl(id, filePosition);\n    ctx.setBtnState(id, PLAYBACK_STATE.PLAY);\n    ctx.setProgress(id, progress);\n    ctx.current = {\n      id,\n      start: progress,\n      duration,\n      state: PLAYBACK_STATE.PLAY\n    };\n    startUpdateProg();\n  }, [ctx, api, mediaElement, stopUpdateProg, startUpdateProg]);\n  return [playback, seek, ctx.externalControler];\n}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/components/RecordList/useRecordPlayer.js"],"names":["React","useMemo","useState","useEffect","useCallback","useContext","getApi","PLAYBACK_STATE","PlayerContext","createContext","btnStateHandlers","setProgressHandlers","getProgressDataHandler","progressUpdaterHandler","current","id","start","duration","progress","state","setBtnCtrlHandler","handler","setBtnState","setProgressHandler","push","setProgress","setProgressDataHandler","getProgress","externalControler","playback","seek","volume","useRecordPlayer","mediaElement","setMediaElement","progressUpdater","setProgressUpdater","ctx","api","medEl","document","createElement","autoplay","preload","startUpdateProg","setInterval","startTime","currTime","currentTime","stopUpdateProg","clearInterval","pbState","PLAY","filePosition","src","getRecordUrl","play","PAUSE","pause"],"mappings":"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","sourcesContent":["import React, { useMemo, useState, useEffect, useCallback, useContext } from \"react\"\r\nimport { getApi } from \"./../../../../apis/apiProvider\";\r\nimport {PLAYBACK_STATE} from \"./ListItem/PlaybackButton/PlaybackButton\";\r\n\r\n//getRecordUrl\r\nexport const PlayerContext = React.createContext({\r\n    btnStateHandlers: {},\r\n    setProgressHandlers:[],\r\n    getProgressDataHandler: [],\r\n    progressUpdaterHandler: null, \r\n    current : {\r\n        id: null,\r\n        start: 0,\r\n        duration: 0,\r\n        progress: 0,\r\n        state : null,\r\n    },\r\n\r\n    setBtnCtrlHandler(id, handler){\r\n        this.btnStateHandlers[id] = handler;\r\n    },\r\n\r\n    setBtnState(id, state){\r\n        this.btnStateHandlers[id](state)\r\n    },\r\n\r\n    setProgressHandler(id, handler){\r\n        if(this.setProgressHandlers[id]){\r\n            this.setProgressHandlers[id].push(handler);\r\n        }\r\n        this.setProgressHandlers[id] = [handler];\r\n    },\r\n\r\n    setProgress(id, progress){\r\n        for(let handler of this.setProgressHandlers[id]){\r\n            handler(progress)\r\n        }\r\n        this.current.progress = progress;\r\n    },\r\n  \r\n    setProgressDataHandler(id, handler){\r\n        this.getProgressDataHandler[id] = handler;\r\n    },\r\n\r\n    getProgress(id){\r\n        return this.getProgressDataHandler[id]();\r\n    },\r\n\r\n    externalControler : {\r\n        current:this.current,\r\n        playback(state){},\r\n        seek(){},\r\n        volume(){},\r\n    }\r\n})\r\n\r\nexport function useRecordPlayer(){\r\n    const [mediaElement, setMediaElement] = useState(null);\r\n    // const [current, setCurrent] = useState(null);\r\n    // const [currentStart, setCurrentStart] = useState(0);\r\n    const [progressUpdater, setProgressUpdater] = useState(null);\r\n    const ctx = useContext(PlayerContext);\r\n\r\n    const api = useMemo(()=>{\r\n        return getApi('RecordsStore');\r\n    }, [getApi])\r\n\r\n    useEffect(()=>{\r\n        const medEl = document.createElement('audio');\r\n        medEl.autoplay = true;\r\n        medEl.preload = 'metadata'\r\n        setMediaElement(medEl);\r\n        ctx.mediaElement = medEl;\r\n    }, [setMediaElement, ctx])\r\n\r\n    const startUpdateProg = useCallback(()=>{\r\n        const handler = setInterval(()=>{\r\n            const current = ctx.current;\r\n            if(!current.id || !current.duration){\r\n                return;\r\n            }\r\n            const startTime = current.start * (current.duration/1000);\r\n            const currTime = startTime + mediaElement.currentTime;\r\n            const progress = currTime / (current.duration/1000);\r\n            ctx.setProgress(current.id, progress);\r\n        }, 200)\r\n        ctx.progressUpdaterHandler = handler;\r\n    }, [setProgressUpdater, mediaElement, ctx])\r\n\r\n    const stopUpdateProg = useCallback(()=>{\r\n        clearInterval(ctx.progressUpdaterHandler);\r\n    }, [ctx])\r\n\r\n    const playback = useCallback((id, pbState)=>{\r\n        if(pbState === PLAYBACK_STATE.PLAY){\r\n            const {progress, duration, filePosition} = ctx.getProgress(id);\r\n            mediaElement.src = api.getRecordUrl(id, filePosition);\r\n            mediaElement.play();\r\n            if(ctx.current.id){\r\n                ctx.setBtnState(ctx.current.id, PLAYBACK_STATE.PAUSE)\r\n            } \r\n            ctx.current = {\r\n                id,\r\n                duration,\r\n                start: progress,\r\n                progress : progress,\r\n                state: PLAYBACK_STATE.PLAY,\r\n            }\r\n            startUpdateProg()\r\n        } else if(pbState === PLAYBACK_STATE.PAUSE){\r\n            mediaElement.pause();\r\n            ctx.current.state = PLAYBACK_STATE.PAUSE;\r\n            stopUpdateProg(); \r\n        }\r\n    }, [\r\n        mediaElement, \r\n        api, \r\n        ctx, \r\n        stopUpdateProg, \r\n        startUpdateProg,\r\n    ])\r\n\r\n    const seek = useCallback(({id, filePosition, progress, duration}) => {\r\n        stopUpdateProg();\r\n        if(ctx.current.id && ctx.current.id !== id){\r\n            ctx.setBtnState(ctx.current.id, PLAYBACK_STATE.PAUSE);\r\n        }\r\n        mediaElement.src = api.getRecordUrl(id, filePosition);\r\n        ctx.setBtnState(id, PLAYBACK_STATE.PLAY);\r\n        ctx.setProgress(id, progress);\r\n        ctx.current = {\r\n            id,\r\n            start: progress,\r\n            duration,\r\n            state: PLAYBACK_STATE.PLAY\r\n        }\r\n        startUpdateProg();\r\n\r\n    }, [ctx, api , mediaElement,stopUpdateProg, startUpdateProg])\r\n\r\n    return [playback, seek, ctx.externalControler ]\r\n}"]},"metadata":{},"sourceType":"module"}
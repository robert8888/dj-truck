{"ast":null,"code":"import store from \"./../../../store\";\nexport default class Mixer {\n  constructor(channels) {\n    this.config = store.getState().configuration.mixer;\n    this.channels = channels;\n    this.audioNodes = {\n      channels: {}\n    };\n    this.audioDataBuffers = {\n      channels: {}\n    };\n\n    for (let channelName of this.channels.getChannelNames()) {\n      this.audioNodes.channels = { ...this.audioNodes.channels,\n        [channelName]: {}\n      };\n      this.audioDataBuffers.channels = { ...this.audioDataBuffers.channels,\n        [channelName]: null\n      };\n    }\n  }\n\n  setUpAudioNodes(channelName) {\n    let audioCtx = this.channels.getChannel(channelName).backend.ac; //chained from up to down \n\n    this.audioNodes.channels[channelName] = {\n      analyserNode: audioCtx.createAnalyser(),\n      faderVolumeNode: audioCtx.createGain(),\n      gainNode: audioCtx.createGain(),\n      eqHiFilterNode: audioCtx.createBiquadFilter(),\n      eqMidFilterNode: audioCtx.createBiquadFilter(),\n      eqLowFilterNode: audioCtx.createBiquadFilter()\n    };\n    const channel = this.audioNodes.channels[channelName]; //\n\n    channel.analyserNode.fftSize = 256; //\n\n    channel.eqLowFilterNode.type = \"lowshelf\";\n    channel.eqLowFilterNode.frequency.setValueAtTime(this.config.low.frequency, audioCtx.currentTime);\n    channel.eqHiFilterNode.type = \"highshelf\";\n    channel.eqHiFilterNode.frequency.setValueAtTime(this.config.hi.frequency, audioCtx.currentTime);\n    channel.eqMidFilterNode.type = \"peaking\";\n    channel.eqMidFilterNode.frequency.setValueAtTime(this.config.mid.frequency, audioCtx.currentTime);\n    channel.eqMidFilterNode.Q.setValueAtTime(this.config.mid.Q, audioCtx.currentTime); //last in array is firt in chain (on top)\n\n    this.channels.getChannel(channelName).backend.setFilters([channel.eqLowFilterNode, channel.eqMidFilterNode, channel.eqHiFilterNode, channel.gainNode, channel.faderVolumeNode, channel.analyserNode]);\n    this.setUpDataBuffers(channelName);\n  }\n\n  setUpDataBuffers(channelName) {\n    let bufferLength = this.audioNodes.channels[channelName].analyserNode.frequencyBinCount;\n    this.audioDataBuffers.channels[channelName] = new Uint8Array(bufferLength);\n  }\n\n  setGainValue(channelName, knobValue, nodeName) {\n    let gain = 1 + knobValue / 100;\n    let audioCtx = this.channels.getChannel(channelName).backend.ac;\n    let channel = this.audioNodes.channels[channelName];\n    channel[nodeName].gain.setTargetAtTime(parseFloat(gain), audioCtx.currentTime, 0.01);\n  }\n\n  setFilterValue(channelName, knobValue, nodeName) {\n    let audioCtx = this.channels.getChannel(channelName).backend.ac;\n    let channel = this.audioNodes.channels[channelName];\n    channel[nodeName].gain.setValueAtTime(knobValue, audioCtx.currentTime);\n  }\n\n  setGain(channelName, knobValue) {\n    this.setGainValue(channelName, knobValue, 'gainNode');\n  }\n\n  setEqHigh(channelName, knobValue) {\n    this.setFilterValue(channelName, knobValue, 'eqHiFilterNode');\n  }\n\n  setEqMid(channelName, knobValue) {\n    this.setFilterValue(channelName, knobValue, 'eqMidFilterNode');\n  }\n\n  setEqLow(channelName, knobValue) {\n    this.setFilterValue(channelName, knobValue, 'eqLowFilterNode');\n  }\n\n  setFader(value) {\n    //in procent from -50%  to + 50% (not 0.01) but 1\n    let faderVolumeNodeA = this.audioNodes.channels[\"A\"].faderVolumeNode;\n    let faderVolumeNodeB = this.audioNodes.channels[\"B\"].faderVolumeNode;\n    let audioCtxA = this.channels.getChannel(\"A\").backend.ac;\n    let audioCtxB = this.channels.getChannel(\"B\").backend.ac;\n\n    if (!faderVolumeNodeA || !faderVolumeNodeB || !audioCtxA || !audioCtxB) {\n      throw new Error(\"Fased value not set checkout funtion setFader in mixer object\");\n    }\n\n    let percent = (value + 50) / 100;\n    let volA = Math.cos(percent * 0.5 * Math.PI);\n    let volB = Math.cos((1 - percent) * 0.5 * Math.PI);\n    faderVolumeNodeA.gain.setTargetAtTime(volA, audioCtxA.currentTime, 0.01);\n    faderVolumeNodeB.gain.setTargetAtTime(volB, audioCtxB.currentTime, 0.01);\n  }\n\n  getFrequenycySum(channelName) {\n    return this.getFrequencyArray(channelName).reduce((acc, current) => acc + current);\n  }\n\n  getFrequencyArray(channelName) {\n    let bufferArray = this.audioDataBuffers.channels[channelName];\n    this.audioNodes.channels[channelName].analyserNode.getByteFrequencyData(bufferArray);\n    return bufferArray;\n  }\n\n}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/DjTruck/djtruck/src/core/console/mixer/mixer.js"],"names":["store","Mixer","constructor","channels","config","getState","configuration","mixer","audioNodes","audioDataBuffers","channelName","getChannelNames","setUpAudioNodes","audioCtx","getChannel","backend","ac","analyserNode","createAnalyser","faderVolumeNode","createGain","gainNode","eqHiFilterNode","createBiquadFilter","eqMidFilterNode","eqLowFilterNode","channel","fftSize","type","frequency","setValueAtTime","low","currentTime","hi","mid","Q","setFilters","setUpDataBuffers","bufferLength","frequencyBinCount","Uint8Array","setGainValue","knobValue","nodeName","gain","setTargetAtTime","parseFloat","setFilterValue","setGain","setEqHigh","setEqMid","setEqLow","setFader","value","faderVolumeNodeA","faderVolumeNodeB","audioCtxA","audioCtxB","Error","percent","volA","Math","cos","PI","volB","getFrequenycySum","getFrequencyArray","reduce","acc","current","bufferArray","getByteFrequencyData"],"mappings":"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","sourcesContent":["import store from \"./../../../store\";\r\n\r\n\r\nexport default class Mixer{\r\n    constructor(channels){\r\n        this.config = store.getState().configuration.mixer;\r\n        \r\n        this.channels = channels;\r\n        \r\n        this.audioNodes = {\r\n            channels : {\r\n            }\r\n        }\r\n\r\n        this.audioDataBuffers = {\r\n            channels : {}\r\n        }\r\n\r\n        for(let channelName of this.channels.getChannelNames()){\r\n            this.audioNodes.channels = { \r\n                ...this.audioNodes.channels,\r\n                [channelName] : {},\r\n            }\r\n\r\n            this.audioDataBuffers.channels = {\r\n                ...this.audioDataBuffers.channels,\r\n                [channelName] : null,\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n\r\n    setUpAudioNodes(channelName){\r\n        let audioCtx = this.channels.getChannel(channelName).backend.ac;\r\n\r\n        //chained from up to down \r\n        this.audioNodes.channels[channelName] = {\r\n            analyserNode : audioCtx.createAnalyser(),\r\n            faderVolumeNode : audioCtx.createGain(),\r\n            gainNode : audioCtx.createGain(),\r\n            eqHiFilterNode : audioCtx.createBiquadFilter(),\r\n            eqMidFilterNode : audioCtx.createBiquadFilter(),\r\n            eqLowFilterNode : audioCtx.createBiquadFilter(),\r\n\r\n        }\r\n        const channel = this.audioNodes.channels[channelName];\r\n        //\r\n        channel.analyserNode.fftSize = 256;\r\n        //\r\n        channel.eqLowFilterNode.type = \"lowshelf\";\r\n        channel.eqLowFilterNode.frequency.setValueAtTime(this.config.low.frequency, audioCtx.currentTime);\r\n\r\n        channel.eqHiFilterNode.type = \"highshelf\";\r\n        channel.eqHiFilterNode.frequency.setValueAtTime(this.config.hi.frequency, audioCtx.currentTime);\r\n\r\n        channel.eqMidFilterNode.type = \"peaking\";\r\n        channel.eqMidFilterNode.frequency.setValueAtTime(this.config.mid.frequency, audioCtx.currentTime);\r\n        channel.eqMidFilterNode.Q.setValueAtTime(this.config.mid.Q, audioCtx.currentTime);  \r\n\r\n        //last in array is firt in chain (on top)\r\n        this.channels.getChannel(channelName).backend.setFilters([\r\n            channel.eqLowFilterNode, \r\n            channel.eqMidFilterNode, \r\n            channel.eqHiFilterNode, \r\n            channel.gainNode,\r\n            channel.faderVolumeNode,\r\n            channel.analyserNode,\r\n         ])\r\n        \r\n        this.setUpDataBuffers(channelName);\r\n    }\r\n    \r\n    setUpDataBuffers(channelName){\r\n        let bufferLength = this.audioNodes.channels[channelName].analyserNode.frequencyBinCount;\r\n        this.audioDataBuffers.channels[channelName] = new Uint8Array(bufferLength);\r\n    }\r\n\r\n\r\n    setGainValue(channelName, knobValue, nodeName){\r\n        let gain = 1 + knobValue / 100 ;\r\n        let audioCtx = this.channels.getChannel(channelName).backend.ac;\r\n\r\n        let channel = this.audioNodes.channels[channelName];\r\n        channel[nodeName].gain.setTargetAtTime( parseFloat(gain) , audioCtx.currentTime, 0.01);\r\n    }\r\n\r\n    setFilterValue(channelName, knobValue, nodeName){\r\n        let audioCtx = this.channels.getChannel(channelName).backend.ac;\r\n\r\n        let channel = this.audioNodes.channels[channelName];\r\n        channel[nodeName].gain.setValueAtTime( knobValue , audioCtx.currentTime);\r\n    }\r\n\r\n\r\n    setGain(channelName, knobValue){\r\n        this.setGainValue(channelName, knobValue, 'gainNode');\r\n    }\r\n\r\n    setEqHigh(channelName, knobValue){\r\n        this.setFilterValue(channelName, knobValue, 'eqHiFilterNode');\r\n    }\r\n\r\n    setEqMid(channelName, knobValue){\r\n        this.setFilterValue(channelName, knobValue, 'eqMidFilterNode');\r\n    }\r\n\r\n    setEqLow(channelName, knobValue){\r\n        this.setFilterValue(channelName, knobValue, 'eqLowFilterNode');\r\n    }\r\n\r\n    setFader(value){//in procent from -50%  to + 50% (not 0.01) but 1\r\n        let faderVolumeNodeA = this.audioNodes.channels[\"A\"].faderVolumeNode;\r\n        let faderVolumeNodeB = this.audioNodes.channels[\"B\"].faderVolumeNode;\r\n        let audioCtxA = this.channels.getChannel(\"A\").backend.ac;\r\n        let audioCtxB = this.channels.getChannel(\"B\").backend.ac;\r\n        if(!faderVolumeNodeA || !faderVolumeNodeB || !audioCtxA || !audioCtxB){\r\n            throw new Error(\"Fased value not set checkout funtion setFader in mixer object\");\r\n        }\r\n\r\n        let percent = (value + 50)/100;\r\n        let volA = Math.cos(percent * 0.5 * Math.PI);\r\n        let volB = Math.cos((1 - percent) * 0.5 * Math.PI);\r\n\r\n        faderVolumeNodeA.gain.setTargetAtTime(volA, audioCtxA.currentTime, 0.01);\r\n        faderVolumeNodeB.gain.setTargetAtTime(volB, audioCtxB.currentTime, 0.01);\r\n    }\r\n\r\n\r\n    getFrequenycySum(channelName){\r\n        return this.getFrequencyArray(channelName).reduce((acc, current) => acc + current)\r\n    }\r\n\r\n    getFrequencyArray(channelName){\r\n        let bufferArray = this.audioDataBuffers.channels[channelName]\r\n        this.audioNodes.channels[channelName].analyserNode.getByteFrequencyData(bufferArray);\r\n        return bufferArray\r\n    }\r\n}\r\n\r\n"]},"metadata":{},"sourceType":"module"}
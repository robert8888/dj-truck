{"ast":null,"code":"import { useMemo, useState, useEffect, useCallback } from \"react\";\nimport { getApi } from \"./../../../apis/apiProvider\";\nimport { PLAYBACK_STATE } from \"./usePlabackState\"; //getRecordUrl\n\nclass PlayerBus {\n  constructor() {\n    this.progressUpdaterHandler = null;\n    this.current = {\n      id: null,\n      start: 0,\n      duration: 0,\n      progress: 0,\n      state: null,\n      buffered: 0\n    };\n    this.btnStateHandlers = {};\n    this.progressWatchers = {};\n    this.bufferedWatchers = [];\n    this.progressProviders = {};\n    this.currentWatchers = [];\n  }\n\n  setCurrent(nextCurrent) {\n    this.current = nextCurrent;\n    this.spreadCurrentChange();\n  }\n\n  addCurrentWatcher(handler) {\n    this.currentWatchers.push(handler);\n  }\n\n  spreadCurrentChange() {\n    for (let handler of this.currentWatchers) {\n      handler(this.current);\n    }\n  }\n\n  addBtnCtrlHandler(id, handler) {\n    this.btnStateHandlers[id] = handler;\n  }\n\n  setBtnState(id, state) {\n    this.btnStateHandlers[id](state);\n  }\n\n  addProgressWatcher(id, handler) {\n    if (this.progressWatchers[id]) {\n      this.progressWatchers[id].push(handler);\n    } else {\n      this.progressWatchers[id] = [handler];\n    }\n  }\n\n  setProgress(id, progress) {\n    for (let handler of [...this.progressWatchers[id], ...this.progressWatchers['#']]) {\n      handler(progress);\n    }\n\n    this.current.progress = progress;\n  }\n\n  addProgressProvider(id, handler) {\n    this.progressProviders[id] = handler;\n  }\n\n  getProgress(id) {\n    if (!id) {\n      return this.getProgress(this.current.id);\n    }\n\n    return this.progressProviders[id]();\n  }\n\n  setBuffered(buffered) {\n    if (this.current.id) {\n      this.current.buffered = buffered;\n    }\n\n    this.spreadBufferChanges();\n  }\n\n  addBuffredWatcher(handel) {\n    this.bufferedWatchers.push(handel);\n  }\n\n  spreadBufferChanges() {\n    for (let handler of this.bufferedWatchers) {\n      handler(this.current.buffered);\n    }\n  }\n\n}\n\nexport function useRecordPlayer() {\n  const [media, setMediaElement] = useState(null);\n  const [bus, _] = useState(new PlayerBus());\n  const api = useMemo(() => {\n    return getApi('RecordsStore');\n  }, [getApi]);\n  useEffect(() => {\n    const medEl = document.createElement('audio');\n    setMediaElement(medEl);\n    bus.mediaElement = medEl;\n  }, [setMediaElement, bus]);\n  const startUpdateProg = useCallback(() => {\n    const handler = setInterval(() => {\n      const mediaEl = media || bus.mediaElement;\n      const progress = mediaEl.currentTime / (bus.current.duration / 1000);\n      bus.setProgress(bus.current.id, progress); //--\n\n      const bufferdTimeRanges = mediaEl.buffered;\n\n      if (bufferdTimeRanges.length) {\n        const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\n        bus.setBuffered(end / (bus.current.duration / 1000));\n      }\n    }, 200);\n    bus.progressUpdaterHandler = handler;\n  }, [media, bus]);\n  const stopUpdateProg = useCallback(() => {\n    clearInterval(bus.progressUpdaterHandler);\n  }, [bus]);\n  useEffect(() => {\n    if (media) {\n      media.addEventListener(\"ended\", () => {\n        if (bus.current.state === PLAYBACK_STATE.PLAY) {\n          bus.setCurrent({ ...bus.current,\n            state: PLAYBACK_STATE.PAUSE\n          });\n          bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE);\n        }\n\n        stopUpdateProg();\n      });\n      media.addEventListener('progress', () => {\n        const bufferdTimeRanges = media.buffered;\n\n        if (bufferdTimeRanges.length) {\n          const end = bufferdTimeRanges.end(bufferdTimeRanges.length - 1);\n          bus.setBuffered(end / (bus.current.duration / 1000));\n        }\n      });\n    }\n  }, [media, bus]);\n  const playback = useCallback((id, pbState) => {\n    const current = id ? false : true;\n    id = id || bus.current.id;\n\n    if (!id) {\n      return;\n    }\n\n    if (pbState === PLAYBACK_STATE.PLAY) {\n      const {\n        progress,\n        duration\n      } = bus.getProgress(id);\n      const position = duration / 1000 * progress;\n      media.src = api.getRecordUrl(id);\n      media.currentTime = position;\n      media.play();\n\n      if (bus.current.id && !current) {\n        bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE);\n      }\n\n      bus.setCurrent({\n        id,\n        duration,\n        progress: progress,\n        buffered: 0,\n        state: PLAYBACK_STATE.PLAY\n      });\n      startUpdateProg();\n    } else if (pbState === PLAYBACK_STATE.PAUSE) {\n      media.pause();\n      bus.setCurrent({ ...bus.current,\n        state: PLAYBACK_STATE.PAUSE\n      });\n      stopUpdateProg();\n    }\n\n    if (current) {\n      bus.setBtnState(id, pbState);\n    }\n  }, [media, api, bus, stopUpdateProg, startUpdateProg]);\n  const seek = useCallback(({\n    id = bus.current.id,\n    progress,\n    duration = bus.current.duration\n  }) => {\n    const mediaEl = media || bus.mediaElement;\n\n    if (!id || !duration) {\n      return;\n    }\n\n    if (bus.current.id && bus.current.id !== id) {\n      bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE);\n    }\n\n    const position = duration / 1000 * progress;\n\n    if (isNaN(position)) {\n      return;\n    }\n\n    stopUpdateProg();\n\n    if (bus.current.id !== id) {\n      mediaEl.src = api.getRecordUrl(id);\n      mediaEl.currentTime = position;\n      bus.setBtnState(id, PLAYBACK_STATE.PLAY);\n      bus.setProgress(id, progress);\n      bus.setCurrent({ ...bus.current,\n        id,\n        duration,\n        state: PLAYBACK_STATE.PLAY\n      });\n    }\n\n    mediaEl.currentTime = position;\n\n    if (mediaEl.pause) {\n      mediaEl.play();\n      bus.setBtnState(bus.current.id, PLAYBACK_STATE.PLAY);\n      bus.setCurrent({ ...bus.current,\n        state: PLAYBACK_STATE.PLAY\n      });\n    }\n\n    startUpdateProg();\n  }, [bus, api, media, stopUpdateProg, startUpdateProg]);\n  const setVolume = useCallback(level => {\n    const mediaElement = media || bus.mediaElement;\n\n    if (!mediaElement) {\n      return;\n    }\n\n    mediaElement.volume = level;\n  }, [bus, media]);\n  const controls = useMemo(() => ({\n    playback,\n    seek,\n    setVolume,\n    playerBus: bus\n  }));\n  return [controls];\n}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/Hooks/useRecordPlayer.js"],"names":["useMemo","useState","useEffect","useCallback","getApi","PLAYBACK_STATE","PlayerBus","progressUpdaterHandler","current","id","start","duration","progress","state","buffered","btnStateHandlers","progressWatchers","bufferedWatchers","progressProviders","currentWatchers","setCurrent","nextCurrent","spreadCurrentChange","addCurrentWatcher","handler","push","addBtnCtrlHandler","setBtnState","addProgressWatcher","setProgress","addProgressProvider","getProgress","setBuffered","spreadBufferChanges","addBuffredWatcher","handel","useRecordPlayer","media","setMediaElement","bus","_","api","medEl","document","createElement","mediaElement","startUpdateProg","setInterval","mediaEl","currentTime","bufferdTimeRanges","length","end","stopUpdateProg","clearInterval","addEventListener","PLAY","PAUSE","playback","pbState","position","src","getRecordUrl","play","pause","seek","isNaN","setVolume","level","volume","controls","playerBus"],"mappings":"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","sourcesContent":["import { useMemo, useState, useEffect, useCallback } from \"react\"\r\nimport { getApi } from \"./../../../apis/apiProvider\";\r\nimport { PLAYBACK_STATE } from \"./usePlabackState\";\r\n\r\n//getRecordUrl\r\nclass PlayerBus {\r\n    progressUpdaterHandler = null;\r\n\r\n    current = {\r\n        id: null,\r\n        start: 0,\r\n        duration: 0,\r\n        progress: 0,\r\n        state: null,\r\n        buffered: 0,\r\n    };\r\n\r\n    btnStateHandlers = {}\r\n    progressWatchers = {}\r\n    bufferedWatchers = []\r\n    progressProviders = {};\r\n    currentWatchers = [];\r\n\r\n    setCurrent(nextCurrent){\r\n        this.current = nextCurrent;\r\n        this.spreadCurrentChange();\r\n    }\r\n\r\n    addCurrentWatcher(handler){\r\n        this.currentWatchers.push(handler)\r\n    }\r\n\r\n    spreadCurrentChange(){\r\n        for(let handler of this.currentWatchers){\r\n            handler(this.current);\r\n        }\r\n    }\r\n\r\n    addBtnCtrlHandler(id, handler) {\r\n        this.btnStateHandlers[id] = handler;\r\n    }\r\n\r\n    setBtnState(id, state) {\r\n        this.btnStateHandlers[id](state)\r\n    }\r\n\r\n    addProgressWatcher(id, handler) {\r\n        if (this.progressWatchers[id]) {\r\n            this.progressWatchers[id].push(handler);\r\n            \r\n        } else{\r\n            this.progressWatchers[id] = [handler];\r\n        }\r\n    }\r\n\r\n    setProgress(id, progress) {\r\n        for (let handler of \r\n            [...this.progressWatchers[id], \r\n             ...this.progressWatchers['#']]) {\r\n            handler(progress)\r\n        }\r\n        this.current.progress = progress;\r\n    }\r\n\r\n    addProgressProvider(id, handler) {\r\n        this.progressProviders[id] = handler;\r\n    }\r\n\r\n    getProgress(id) {\r\n        if(!id){\r\n            return this.getProgress(this.current.id);\r\n        }\r\n        return this.progressProviders[id]();\r\n    }\r\n\r\n    setBuffered(buffered){\r\n        if(this.current.id){\r\n            this.current.buffered = buffered;\r\n        }\r\n        this.spreadBufferChanges();\r\n    }\r\n\r\n    addBuffredWatcher(handel){\r\n        this.bufferedWatchers.push(handel)\r\n    }\r\n\r\n    spreadBufferChanges(){\r\n        for(let handler of this.bufferedWatchers){\r\n            handler(this.current.buffered);\r\n        }\r\n    }\r\n}\r\n\r\nexport function useRecordPlayer() {\r\n    const [media, setMediaElement] = useState(null);\r\n    const [bus, _] = useState(new PlayerBus())\r\n\r\n    const api = useMemo(() => {\r\n        return getApi('RecordsStore');\r\n    }, [getApi])\r\n\r\n    useEffect(() => {\r\n        const medEl = document.createElement('audio');\r\n        setMediaElement(medEl);\r\n        bus.mediaElement = medEl;\r\n    }, [setMediaElement, bus])\r\n\r\n    const startUpdateProg = useCallback(() => {\r\n        const handler = setInterval(() => {\r\n            const mediaEl = media || bus.mediaElement;\r\n            const progress = mediaEl.currentTime / (bus.current.duration / 1000);\r\n            bus.setProgress(bus.current.id, progress);\r\n            //--\r\n            const bufferdTimeRanges = mediaEl.buffered;\r\n            if(bufferdTimeRanges.length){\r\n                const end = bufferdTimeRanges.end(bufferdTimeRanges.length-1);\r\n                bus.setBuffered(end / (bus.current.duration / 1000))\r\n            } \r\n        }, 200)\r\n        bus.progressUpdaterHandler = handler;\r\n    }, [media, bus])\r\n\r\n    const stopUpdateProg = useCallback(() => {\r\n        clearInterval(bus.progressUpdaterHandler);\r\n    }, [bus])\r\n\r\n    useEffect(()=>{\r\n        if(media){\r\n            media.addEventListener(\"ended\", ()=>{\r\n                if(bus.current.state === PLAYBACK_STATE.PLAY){\r\n                    bus.setCurrent({\r\n                        ...bus.current,\r\n                        state : PLAYBACK_STATE.PAUSE,\r\n                    })\r\n                    bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE)\r\n                }\r\n                stopUpdateProg();\r\n            })\r\n            media.addEventListener('progress', ()=>{\r\n                const bufferdTimeRanges = media.buffered;\r\n                if(bufferdTimeRanges.length){\r\n                    const end = bufferdTimeRanges.end(bufferdTimeRanges.length-1);\r\n                    bus.setBuffered(end / (bus.current.duration / 1000))\r\n                } \r\n            })\r\n        }\r\n    }, [media, bus])\r\n\r\n    const playback = useCallback((id, pbState) => {\r\n        const current = (id) ? false : true;\r\n        id = id || bus.current.id;\r\n        if(!id){\r\n            return;\r\n        }\r\n        if (pbState === PLAYBACK_STATE.PLAY) {\r\n            const { progress, duration } = bus.getProgress(id);\r\n            const position = (duration / 1000) * progress;\r\n            media.src = api.getRecordUrl(id);\r\n            media.currentTime = position;\r\n            media.play();\r\n            if (bus.current.id && !current) {\r\n                bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE)\r\n            }\r\n            bus.setCurrent({\r\n                id,\r\n                duration,\r\n                progress: progress,\r\n                buffered: 0,\r\n                state: PLAYBACK_STATE.PLAY,\r\n            })\r\n            startUpdateProg()\r\n        } else if (pbState === PLAYBACK_STATE.PAUSE) {\r\n            media.pause();\r\n            bus.setCurrent({\r\n                ...bus.current,\r\n                state: PLAYBACK_STATE.PAUSE\r\n            })\r\n            stopUpdateProg();\r\n        }\r\n        if(current){\r\n            bus.setBtnState(id, pbState)\r\n        }\r\n    }, [\r\n        media,\r\n        api,\r\n        bus,\r\n        stopUpdateProg,\r\n        startUpdateProg,\r\n    ])\r\n\r\n    const seek = useCallback(({ \r\n            id = bus.current.id, \r\n            progress, \r\n            duration = bus.current.duration \r\n        }) => {\r\n        const mediaEl = media || bus.mediaElement;\r\n\r\n        if(!id || !duration){\r\n            return;\r\n        }\r\n\r\n        if (bus.current.id && bus.current.id !== id) {\r\n            bus.setBtnState(bus.current.id, PLAYBACK_STATE.PAUSE);\r\n        }\r\n        const position = (duration / 1000) * progress;\r\n\r\n        if(isNaN(position)){\r\n            return;\r\n        }\r\n\r\n        stopUpdateProg();\r\n        if (bus.current.id !== id) {\r\n            mediaEl.src = api.getRecordUrl(id);\r\n            mediaEl.currentTime = position;\r\n            bus.setBtnState(id, PLAYBACK_STATE.PLAY);\r\n            bus.setProgress(id, progress);\r\n            bus.setCurrent({\r\n                ...bus.current,\r\n                id,\r\n                duration,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n        }\r\n\r\n        mediaEl.currentTime = position;\r\n        if (mediaEl.pause) {\r\n            mediaEl.play();\r\n            bus.setBtnState(bus.current.id, PLAYBACK_STATE.PLAY);\r\n            bus.setCurrent({\r\n                ...bus.current,\r\n                state: PLAYBACK_STATE.PLAY\r\n            })\r\n        }\r\n        startUpdateProg();\r\n    }, [bus, api, media, stopUpdateProg, startUpdateProg])\r\n\r\n    const setVolume = useCallback((level)=>{\r\n        const mediaElement = media || bus.mediaElement;\r\n        if(!mediaElement){\r\n            return;\r\n        }\r\n        mediaElement.volume = level;\r\n    }, [bus, media])\r\n\r\n    const controls = useMemo(()=>({\r\n        playback,\r\n        seek,\r\n        setVolume,\r\n        playerBus: bus\r\n    }))\r\n\r\n    return [controls]\r\n}"]},"metadata":{},"sourceType":"module"}
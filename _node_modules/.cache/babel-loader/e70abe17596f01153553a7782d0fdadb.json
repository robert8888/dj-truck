{"ast":null,"code":"import React, { useMemo, useState, useEffect, useCallback, useContext } from \"react\";\nimport { getApi } from \"./../../../../apis/apiProvider\";\nimport { PLAYBACK_STATE } from \"./ListItem/PlaybackButton/PlaybackButton\"; //getRecordUrl\n\nexport const PlayerContext = React.createContext({\n  btnStateHandlers: {},\n  setProgressHandlers: [],\n  getProgressDataHandler: [],\n\n  setBtnCtrlHandler(id, handler) {\n    this.btnStateHandlers[id] = handler;\n  },\n\n  setBtnState(id, state) {\n    this.btnStateHandlers[id](state);\n  },\n\n  setProgressHandler(id, handler) {\n    if (this.setProgressHandlers[id]) {\n      this.setProgressHandlers[id].push(handler);\n    }\n\n    this.setProgressHandlers[id] = [handler];\n  },\n\n  setProgress(id, progress) {\n    for (let handler of this.setProgressHandlers[id]) {\n      handler(progress);\n    }\n  },\n\n  setProgressDataHandler(id, handler) {\n    this.getProgressDataHandler[id] = handler;\n  },\n\n  getProgress(id) {\n    return this.getProgressDataHandler[id]();\n  }\n\n});\nexport function useRecordPlayer() {\n  const [mediaElement, setMediaElement] = useState(null); // const [current, setCurrent] = useState(null);\n  // const [currentStart, setCurrentStart] = useState(0);\n\n  const [current, setCurrent] = useState({\n    id: null,\n    start: 0,\n    duration: 0\n  });\n  const [progressUpdater, setProgressUpdater] = useState(null);\n  const ctrContext = useContext(PlayerContext);\n  const api = useMemo(() => {\n    return getApi('RecordsStore');\n  }, [getApi]);\n  useEffect(() => {\n    const medEl = document.createElement('audio');\n    medEl.autoplay = true;\n    medEl.preload = 'metadata';\n    setMediaElement(medEl);\n  }, [setMediaElement]);\n  const startUpdateProg = useCallback(current => {\n    const handler = setInterval(() => {\n      console.log(current);\n\n      if (!current.id || !current.duration) {\n        return;\n      }\n\n      const startTime = current.start * (current.duration / 1000);\n      const currTime = startTime + mediaElement.currentTime;\n      const progress = currTime / (current.duration / 1000);\n      console.log(current.id, progress);\n      ctrContext.setProgress(current.id, progress);\n    }, 200);\n    console.log(\"handler is \", handler);\n    setProgressUpdater(handler);\n  }, [setProgressUpdater, mediaElement, ctrContext]);\n  const stopUpdateProg = useCallback(() => {\n    console.log(\"stop prog\", progressUpdater);\n    clearInterval(progressUpdater);\n  }, [progressUpdater]);\n  const playback = useCallback((id, pbState) => {\n    if (pbState === PLAYBACK_STATE.PLAY) {\n      const {\n        progress,\n        duration,\n        filePosition\n      } = ctrContext.getProgress(id);\n      console.log(\"P , D , F\", progress, duration, filePosition);\n      mediaElement.src = api.getRecordUrl(id, filePosition);\n      mediaElement.play();\n\n      if (current.id) {\n        ctrContext.setBtnState(current.id, PLAYBACK_STATE.PAUSE);\n      }\n\n      console.log(id, duration, progress);\n      const curr = { ...current,\n        id,\n        duration,\n        start: progress\n      };\n      setCurrent(curr);\n      startUpdateProg(curr);\n    } else if (pbState === PLAYBACK_STATE.PAUSE) {\n      mediaElement.pause();\n      stopUpdateProg();\n    }\n  }, [mediaElement, api, current, setCurrent, stopUpdateProg, startUpdateProg, progressUpdater]);\n  const seek = useCallback(({\n    id,\n    filePosition,\n    progress,\n    duration\n  }) => {\n    stopUpdateProg();\n    mediaElement.src = api.getRecordUrl(id, filePosition);\n    ctrContext.setBtnState(id, PLAYBACK_STATE.PLAY);\n    ctrContext.setProgress(id, progress);\n    const curr = {\n      id,\n      start: progress,\n      duration\n    };\n    setCurrent(curr);\n    startUpdateProg(curr); // console.log(\"seek \", id , position)\n  }, [stopUpdateProg, startUpdateProg, setCurrent, ctrContext, api, mediaElement]);\n  return [playback, seek];\n}","map":{"version":3,"sources":["D:/PROJEKTY/APKI/dj-truck/src/pages/common/components/RecordList/useRecordPlayer.js"],"names":["React","useMemo","useState","useEffect","useCallback","useContext","getApi","PLAYBACK_STATE","PlayerContext","createContext","btnStateHandlers","setProgressHandlers","getProgressDataHandler","setBtnCtrlHandler","id","handler","setBtnState","state","setProgressHandler","push","setProgress","progress","setProgressDataHandler","getProgress","useRecordPlayer","mediaElement","setMediaElement","current","setCurrent","start","duration","progressUpdater","setProgressUpdater","ctrContext","api","medEl","document","createElement","autoplay","preload","startUpdateProg","setInterval","console","log","startTime","currTime","currentTime","stopUpdateProg","clearInterval","playback","pbState","PLAY","filePosition","src","getRecordUrl","play","PAUSE","curr","pause","seek"],"mappings":"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","sourcesContent":["import React, { useMemo, useState, useEffect, useCallback, useContext } from \"react\"\r\nimport { getApi } from \"./../../../../apis/apiProvider\";\r\nimport {PLAYBACK_STATE} from \"./ListItem/PlaybackButton/PlaybackButton\";\r\n\r\n//getRecordUrl\r\nexport const PlayerContext = React.createContext({\r\n    btnStateHandlers: {},\r\n    setProgressHandlers:[],\r\n    getProgressDataHandler: [],\r\n\r\n    setBtnCtrlHandler(id, handler){\r\n        this.btnStateHandlers[id] = handler;\r\n    },\r\n\r\n    setBtnState(id, state){\r\n        this.btnStateHandlers[id](state)\r\n    },\r\n\r\n    setProgressHandler(id, handler){\r\n        if(this.setProgressHandlers[id]){\r\n            this.setProgressHandlers[id].push(handler);\r\n        }\r\n        this.setProgressHandlers[id] = [handler];\r\n    },\r\n\r\n    setProgress(id, progress){\r\n        for(let handler of this.setProgressHandlers[id]){\r\n            handler(progress)\r\n        }\r\n    },\r\n  \r\n    setProgressDataHandler(id, handler){\r\n        this.getProgressDataHandler[id] = handler;\r\n    },\r\n\r\n    getProgress(id){\r\n        return this.getProgressDataHandler[id]();\r\n    }\r\n})\r\n\r\nexport function useRecordPlayer(){\r\n    const [mediaElement, setMediaElement] = useState(null);\r\n    // const [current, setCurrent] = useState(null);\r\n    // const [currentStart, setCurrentStart] = useState(0);\r\n    const [current, setCurrent] = useState({\r\n        id: null,\r\n        start: 0,\r\n        duration: 0\r\n    })\r\n    const [progressUpdater, setProgressUpdater] = useState(null);\r\n    const ctrContext = useContext(PlayerContext);\r\n\r\n    const api = useMemo(()=>{\r\n        return getApi('RecordsStore');\r\n    }, [getApi])\r\n\r\n    useEffect(()=>{\r\n        const medEl = document.createElement('audio');\r\n        medEl.autoplay = true;\r\n        medEl.preload = 'metadata'\r\n        setMediaElement(medEl)\r\n    }, [setMediaElement])\r\n\r\n    const startUpdateProg = useCallback((current)=>{\r\n        const handler = setInterval(()=>{\r\n            console.log(current)\r\n            if(!current.id || !current.duration){\r\n                return;\r\n            }\r\n            const startTime = current.start * (current.duration/1000);\r\n            const currTime = startTime + mediaElement.currentTime;\r\n            const progress = currTime / (current.duration/1000);\r\n            console.log(current.id, progress)\r\n            ctrContext.setProgress(current.id, progress);\r\n        }, 200)\r\n        console.log(\"handler is \", handler)\r\n        setProgressUpdater(handler)\r\n    }, [setProgressUpdater, mediaElement, ctrContext])\r\n\r\n    const stopUpdateProg = useCallback(()=>{\r\n        console.log(\"stop prog\", progressUpdater)\r\n        clearInterval(progressUpdater);\r\n    }, [progressUpdater])\r\n\r\n    const playback = useCallback((id, pbState)=>{\r\n        if(pbState === PLAYBACK_STATE.PLAY){\r\n            const {progress, duration, filePosition} = ctrContext.getProgress(id);\r\n\r\n            console.log(\"P , D , F\", progress, duration, filePosition)\r\n\r\n            mediaElement.src = api.getRecordUrl(id, filePosition);\r\n            mediaElement.play();\r\n            if(current.id){\r\n                ctrContext.setBtnState(current.id, PLAYBACK_STATE.PAUSE)\r\n            } \r\n            console.log(id, duration, progress);\r\n            const curr = {\r\n                ...current,\r\n                id,\r\n                duration,\r\n                start: progress\r\n            }\r\n            setCurrent(curr);\r\n            startUpdateProg(curr);\r\n        } else if(pbState === PLAYBACK_STATE.PAUSE){\r\n            mediaElement.pause();\r\n            stopUpdateProg(); \r\n        }\r\n    }, [\r\n        mediaElement, \r\n        api, \r\n        current, \r\n        setCurrent, \r\n        stopUpdateProg, \r\n        startUpdateProg,\r\n        progressUpdater\r\n    ])\r\n\r\n    const seek = useCallback(({id, filePosition, progress, duration}) => {\r\n        stopUpdateProg();\r\n        mediaElement.src = api.getRecordUrl(id, filePosition);\r\n        ctrContext.setBtnState(id, PLAYBACK_STATE.PLAY);\r\n        ctrContext.setProgress(id, progress);\r\n        const curr = {\r\n            id,\r\n            start: progress,\r\n            duration\r\n        }\r\n        setCurrent(curr)\r\n        startUpdateProg(curr);\r\n        // console.log(\"seek \", id , position)\r\n    }, [stopUpdateProg, startUpdateProg, setCurrent, ctrContext, api , mediaElement])\r\n\r\n\r\n\r\n    return [playback, seek ]\r\n}"]},"metadata":{},"sourceType":"module"}